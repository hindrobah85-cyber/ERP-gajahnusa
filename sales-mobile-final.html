<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAJAH NUSA ERP - Sales Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .app-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-grid-extended {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 15px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .nav-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .content-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .store-list {
            margin-bottom: 20px;
        }

        .store-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .store-item:hover {
            background: #e9ecef;
        }

        .store-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .store-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
            cursor: pointer;
            pointer-events: auto;
        }

        .store-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .store-info p {
            color: #666;
            font-size: 14px;
        }

        .route-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .route-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .tagihan-list {
            margin-bottom: 20px;
        }

        .tagihan-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tagihan-item:hover {
            background: #e9ecef;
        }

        .tagihan-item.selected {
            background: #e8f5e8;
            border-color: #28a745;
        }

        .tagihan-item.batch-selected {
            background: #fff3cd;
            border-color: #ffc107;
            border-left-width: 6px;
        }

        .invoice-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .batch-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .batch-item {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .batch-item:last-child {
            border-bottom: none;
        }

        .batch-allocation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .allocation-item {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }

        .allocation-item.lunas {
            background: #e8f5e8;
            border-left-color: #28a745;
        }

        .allocation-item.titip {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .allocation-item.belum_bayar {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .status-lunas {
            background: #28a745;
            color: white;
        }

        .status-titip {
            background: #ffc107;
            color: #212529;
        }

        .tagihan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tagihan-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-terlambat {
            background: #ffebee;
            color: #c62828;
        }

        .status-wajib-tagih {
            background: #ffcdd2;
            color: #b71c1c;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status-lancar {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .payment-form {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .payment-method {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-method.selected {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .file-upload {
            margin: 15px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .camera-preview {
            margin-top: 15px;
            text-align: center;
        }

        .photo-preview {
            display: inline-block;
            margin: 5px;
            position: relative;
        }

        .photo-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .remove-photo {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .period-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .period-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .period-tab.active {
            background: #667eea;
            color: white;
        }

        .hidden {
            display: none;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .order-list {
            margin-bottom: 20px;
        }

        .order-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }

        .order-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 5px;
        }

        .order-kunjungan {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .order-telpon {
            background: #e3f2fd;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üêò</div>
            <h1 class="app-title">GAJAH NUSA ERP</h1>
            <p class="app-subtitle">Sales Mobile Application</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="card">
            <h2 style="text-align: center; margin-bottom: 25px; color: #333;">Login Sales</h2>
            
            <form onsubmit="return handleLoginSubmit(event)">
                <div class="form-group">
                    <label class="form-label">Employee ID</label>
                    <input type="text" id="employeeId" class="form-input" placeholder="Masukkan Employee ID" value="EMP001" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Masukkan Password" value="password123" required>
                </div>

                <button onclick="login()" class="btn btn-primary" type="button">üîê Login</button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <a href="register_fixed.html" style="color: #667eea; text-decoration: none;">Belum punya akun? Daftar di sini</a>
                </div>
            </form>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="card">
                <h3 style="margin-bottom: 20px; text-align: center;">Dashboard Sales</h3>
                
                <div class="nav-grid-extended">
                    <button onclick="showCallPlan()" class="nav-btn">üìç Call Plan</button>
                    <button onclick="showTagihan()" class="nav-btn" id="tagihanBtn">üí≥ Tagihan</button>
                    <button onclick="showOrderan()" class="nav-btn" id="orderanBtn">üì¶ Orderan</button>
                    <button onclick="showOrderTelpon()" class="nav-btn">üìû Order Telpon</button>
                    <button onclick="showTagihanTelpon()" class="nav-btn">üìûüí≥ Tagihan Telpon</button>
                    <button onclick="showStock()" class="nav-btn">üì¶üìä Stock</button>
                    <button onclick="showInfo()" class="nav-btn">üìä Info</button>
                    <button onclick="showPerforma()" class="nav-btn">üìà Performa</button>
                    <button onclick="showPengumuman()" class="nav-btn">üì¢ Pengumuman</button>
                    <button onclick="showCustomerBaru()" class="nav-btn">üÜï Customer Baru</button>
                </div>

                <div id="callPlanAlert" class="alert alert-warning">
                    ‚ö†Ô∏è Anda harus membuat Call Plan terlebih dahulu sebelum mengakses Tagihan dan Orderan Kunjungan!
                </div>

                <button onclick="logout()" class="btn logout-btn">üö™ Logout</button>
            </div>

            <!-- Content Area -->
            <div id="contentArea" class="content-area hidden">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let isLoggedIn = false;
        let currentUser = null;
        let callPlanCreated = false;
        let currentRoute = null;
        let capturedPhotos = [];
        let performanceData = {
            daily: { visits: 8, orders: 5, bills: 3, newCustomers: 2 },
            weekly: { visits: 35, orders: 24, bills: 18, newCustomers: 8 },
            monthly: { visits: 142, orders: 98, bills: 76, newCustomers: 25 }
        };
        let currentPeriod = 'daily';

        // Handle form submission
        function handleLoginSubmit(event) {
            event.preventDefault();
            console.log('Form submitted, calling login function');
            login();
            return false;
        }

        // Login Function
        function login() {
            console.log('Login function called');
            const employeeId = document.getElementById('employeeId').value;
            const password = document.getElementById('password').value;
            console.log('Employee ID:', employeeId, 'Password:', password);

            if (employeeId === 'EMP001' && password === 'password123') {
                console.log('Login credentials valid');
                isLoggedIn = true;
                currentUser = {
                    id: employeeId,
                    name: 'Ahmad Salesman',
                    department: 'Sales'
                };

                console.log('Hiding login form');
                document.getElementById('loginForm').style.display = 'none';
                console.log('Adding active class to dashboard');
                document.getElementById('dashboard').classList.add('active');
                
                console.log('Updating dashboard buttons');
                updateDashboardButtons();
                
                alert('‚úÖ Login berhasil! Selamat datang, ' + currentUser.name);
            } else {
                console.log('Login credentials invalid');
                alert('‚ùå Login gagal! Gunakan EMP001 / password123');
            }
        }

        // Logout Function
        function logout() {
            isLoggedIn = false;
            currentUser = null;
            callPlanCreated = false;
            selectedStores = [];
            currentRoute = null;
            
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('contentArea').classList.add('hidden');
            
            alert('üëã Logout berhasil!');
        }

        // Update Dashboard Buttons
        function updateDashboardButtons() {
            const tagihanBtn = document.getElementById('tagihanBtn');
            const orderanBtn = document.getElementById('orderanBtn');
            const alert = document.getElementById('callPlanAlert');
            
            if (callPlanCreated) {
                tagihanBtn.classList.remove('disabled');
                orderanBtn.classList.remove('disabled');
                alert.style.display = 'none';
            } else {
                tagihanBtn.classList.add('disabled');
                orderanBtn.classList.add('disabled');
                alert.style.display = 'block';
            }
        }

        // Show Call Plan
        function showCallPlan() {
            const content = `
                <div class="section-title">üìç Call Plan Dashboard</div>
                
                <div class="search-section">
                    <input type="text" id="storeSearch" class="form-input" placeholder="üîç Cari nama toko..." onkeyup="filterStores()">
                    <div class="filter-buttons">
                        <button onclick="filterByArea('semua')" class="filter-btn active" id="filter-semua">Semua Kecamatan</button>
                        <button onclick="filterByArea('Menteng')" class="filter-btn" id="filter-menteng">Menteng</button>
                        <button onclick="filterByArea('Kebayoran Baru')" class="filter-btn" id="filter-kebayoran">Kebayoran Baru</button>
                        <button onclick="filterByArea('Kebon Jeruk')" class="filter-btn" id="filter-kebon-jeruk">Kebon Jeruk</button>
                        <button onclick="filterByArea('Kelapa Gading')" class="filter-btn" id="filter-kelapa-gading">Kelapa Gading</button>
                        <button onclick="filterByArea('Jatinegara')" class="filter-btn" id="filter-jatinegara">Jatinegara</button>
                    </div>
                </div>
                
                <div class="selected-counter">
                    <span id="selectedCount">0</span> toko terpilih dari <span id="totalStores">0</span> toko
                </div>
                
                <!-- ML Prediction Section -->
                <div class="ml-prediction-section" style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">ü§ñ AI Call Plan Recommendation</h4>
                    <div id="mlRecommendation" style="font-size: 14px; color: #155724;">
                        <p>üìä Menganalisis pola kunjungan dan performa sales...</p>
                        <button onclick="generateMLRecommendation()" class="btn btn-success" style="margin-top: 10px;">üéØ Generate Smart Recommendation</button>
                    </div>
                </div>
                
                <div class="store-list" id="storeList">
                    <!-- Stores will be populated here -->
                </div>
                
                <div class="action-buttons">
                    <button onclick="selectAll()" class="btn btn-secondary">‚úÖ Pilih Semua</button>
                    <button onclick="clearSelection()" class="btn btn-secondary">‚ùå Hapus Pilihan</button>
                    <button onclick="generateRoute()" class="btn btn-primary">üó∫Ô∏è Generate Rute GPS</button>
                </div>
                
                <div id="routeDisplay" class="route-info hidden">
                    <h4>üó∫Ô∏è Rute Kunjungan</h4>
                    <div id="routeDetails"></div>
                    <button onclick="editRoute()" class="btn btn-secondary">‚úèÔ∏è Edit Rute</button>
                    <button onclick="fixCallPlan()" class="btn btn-success">‚úÖ Fix Call Plan</button>
                </div>
                
                <style>
                .search-section {
                    margin-bottom: 20px;
                }
                
                .filter-buttons {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    margin-top: 10px;
                }
                
                .filter-btn {
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 20px;
                    background: white;
                    color: #666;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                
                .filter-btn.active {
                    background: #667eea;
                    color: white;
                    border-color: #667eea;
                }
                
                .selected-counter {
                    background: #e3f2fd;
                    padding: 10px;
                    border-radius: 8px;
                    text-align: center;
                    font-weight: 600;
                    margin-bottom: 15px;
                    color: #1976d2;
                }
                
                .store-compact {
                    display: flex;
                    align-items: center;
                    padding: 10px 15px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    border: 2px solid transparent;
                    transition: all 0.3s ease;
                    cursor: pointer;
                }
                
                .store-compact:hover {
                    background: #e9ecef;
                }
                
                .store-compact.selected {
                    background: #e3f2fd;
                    border-color: #2196f3;
                }
                
                .store-compact .store-checkbox {
                    margin-right: 12px;
                }
                
                .store-compact .store-name {
                    flex: 1;
                    font-weight: 600;
                    color: #333;
                }
                
                .store-compact .store-area {
                    font-size: 12px;
                    color: #666;
                    background: #e9ecef;
                    padding: 2px 8px;
                    border-radius: 12px;
                }
                
                .action-buttons {
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 10px;
                    margin: 20px 0;
                }
                
                .action-buttons .btn {
                    margin: 0;
                    padding: 12px;
                    font-size: 14px;
                }
                
                .route-summary {
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 8px;
                }
                
                .route-stat {
                    text-align: center;
                }
                
                .stat-label {
                    display: block;
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 5px;
                }
                
                .stat-value {
                    display: block;
                    font-size: 18px;
                    font-weight: bold;
                    color: #333;
                }
                
                .route-list {
                    max-height: 300px;
                    overflow-y: auto;
                }
                
                .route-item {
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    margin-bottom: 8px;
                }
                
                .route-sequence {
                    width: 30px;
                    height: 30px;
                    background: #667eea;
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    margin-right: 12px;
                    flex-shrink: 0;
                }
                
                .route-info {
                    flex: 1;
                }
                
                .route-info h5 {
                    margin: 0 0 5px 0;
                    font-size: 14px;
                    color: #333;
                }
                
                .route-info p {
                    margin: 2px 0;
                    font-size: 12px;
                    color: #666;
                }
                </style>
            `;
            
            showContent(content);
            loadStoreData();
        }

        // Store management functions
        let storeData = [];
        let selectedStores = [];
        let currentFilter = 'semua';
        
        function loadStoreData() {
            // Sample data untuk 50+ toko dengan kecamatan
            storeData = [
                {id: 1, name: 'Toko Sari Rasa', area: 'Menteng', kecamatan: 'Menteng', address: 'Jl. Merdeka No. 123', phone: '021-1234567', contact: 'Pak Budi', hours: '08:00 - 17:00', lat: -6.1944, lng: 106.8229, type: 'Toko Besar', salesHistory: {totalVisits: 24, successRate: 85, avgOrderValue: 850000}},
                {id: 2, name: 'Warung Maju Jaya', area: 'Kebayoran Baru', kecamatan: 'Kebayoran Baru', address: 'Jl. Sudirman No. 456', phone: '021-7654321', contact: 'Bu Siti', hours: '07:00 - 19:00', lat: -6.2297, lng: 106.7983, type: 'Toko Menengah', salesHistory: {totalVisits: 18, successRate: 75, avgOrderValue: 650000}},
                {id: 3, name: 'Toko Berkah', area: 'Kebon Jeruk', kecamatan: 'Kebon Jeruk', address: 'Jl. Thamrin No. 789', phone: '021-9876543', contact: 'Pak Ahmad', hours: '06:00 - 18:00', lat: -6.1889, lng: 106.7831, type: 'Toko Besar', salesHistory: {totalVisits: 32, successRate: 90, avgOrderValue: 1200000}},
                {id: 4, name: 'Minimarket Sejahtera', area: 'Jatinegara', kecamatan: 'Jatinegara', address: 'Jl. Gatot Subroto No. 321', phone: '021-5678901', contact: 'Bu Linda', hours: '24 Jam', lat: -6.2146, lng: 106.8785, type: 'Minimarket', salesHistory: {totalVisits: 15, successRate: 65, avgOrderValue: 450000}},
                {id: 5, name: 'Toko Bahagia', area: 'Kelapa Gading', kecamatan: 'Kelapa Gading', address: 'Jl. Ahmad Yani No. 111', phone: '021-1111111', contact: 'Pak Joko', hours: '08:00 - 20:00', lat: -6.1570, lng: 106.9096, type: 'Toko Menengah', salesHistory: {totalVisits: 22, successRate: 80, avgOrderValue: 720000}},
                {id: 6, name: 'Warung Sederhana', area: 'Gambir', kecamatan: 'Gambir', address: 'Jl. MH Thamrin No. 222', phone: '021-2222222', contact: 'Bu Ani', hours: '06:00 - 18:00', lat: -6.1745, lng: 106.8227, type: 'Warung', salesHistory: {totalVisits: 12, successRate: 60, avgOrderValue: 320000}},
                {id: 7, name: 'Toko Makmur', area: 'Kemang', kecamatan: 'Mampang Prapatan', address: 'Jl. Kemang No. 333', phone: '021-3333333', contact: 'Pak Dedi', hours: '07:00 - 19:00', lat: -6.2598, lng: 106.8142, type: 'Toko Besar', salesHistory: {totalVisits: 28, successRate: 85, avgOrderValue: 950000}},
                {id: 8, name: 'Minimarket Ceria', area: 'Grogol Petamburan', kecamatan: 'Grogol Petamburan', address: 'Jl. Puri No. 444', phone: '021-4444444', contact: 'Bu Maya', hours: '06:00 - 22:00', lat: -6.1615, lng: 106.7945, type: 'Minimarket', salesHistory: {totalVisits: 20, successRate: 70, avgOrderValue: 520000}},
                {id: 9, name: 'Toko Mandiri', area: 'Cakung', kecamatan: 'Cakung', address: 'Jl. Cakung No. 555', phone: '021-5555555', contact: 'Pak Rudi', hours: '08:00 - 17:00', lat: -6.1885, lng: 106.9417},
                {id: 10, name: 'Warung Sentosa', area: 'Tanjung Priok', kecamatan: 'Tanjung Priok', address: 'Jl. Sunter No. 666', phone: '021-6666666', contact: 'Bu Rina', hours: '07:00 - 20:00', lat: -6.1063, lng: 106.8801},
                {id: 11, name: 'Toko Rejeki', area: 'Cikini', kecamatan: 'Menteng', address: 'Jl. Cikini No. 777', phone: '021-7777777', contact: 'Pak Andi', hours: '08:00 - 18:00', lat: -6.1975, lng: 106.8407},
                {id: 12, name: 'Minimarket Lestari', area: 'Senayan', kecamatan: 'Kebayoran Baru', address: 'Jl. Radio Dalam No. 888', phone: '021-8888888', contact: 'Bu Dewi', hours: '06:00 - 23:00', lat: -6.2251, lng: 106.8031},
                {id: 13, name: 'Toko Subur', area: 'Meruya', kecamatan: 'Kebon Jeruk', address: 'Jl. Meruya No. 999', phone: '021-9999999', contact: 'Pak Hadi', hours: '07:00 - 19:00', lat: -6.1847, lng: 106.7519},
                {id: 14, name: 'Warung Damai', area: 'Klender', kecamatan: 'Duren Sawit', address: 'Jl. Klender No. 101', phone: '021-1010101', contact: 'Bu Sari', hours: '06:00 - 18:00', lat: -6.2269, lng: 106.9045},
                {id: 15, name: 'Toko Maju', area: 'Kelapa Gading', kecamatan: 'Kelapa Gading', address: 'Jl. Kelapa Gading No. 102', phone: '021-1020102', contact: 'Pak Agus', hours: '08:00 - 20:00', lat: -6.1599, lng: 106.9059},
                {id: 16, name: 'Toko Ramah', area: 'Salemba', kecamatan: 'Senen', address: 'Jl. Salemba No. 103', phone: '021-1030103', contact: 'Bu Lili', hours: '07:00 - 19:00', lat: -6.1871, lng: 106.8439},
                {id: 17, name: 'Warung Harapan', area: 'Permata Hijau', kecamatan: 'Kebayoran Lama', address: 'Jl. Permata Hijau No. 104', phone: '021-1040104', contact: 'Pak Yono', hours: '06:00 - 22:00', lat: -6.2424, lng: 106.7844},
                {id: 18, name: 'Minimarket Prima', area: 'Kebon Jeruk', kecamatan: 'Kebon Jeruk', address: 'Jl. Kebon Jeruk No. 105', phone: '021-1050105', contact: 'Bu Nina', hours: '24 Jam', lat: -6.1936, lng: 106.7831},
                {id: 19, name: 'Toko Gemilang', area: 'Jatinegara', kecamatan: 'Jatinegara', address: 'Jl. Jatinegara No. 106', phone: '021-1060106', contact: 'Pak Bambang', hours: '08:00 - 18:00', lat: -6.2146, lng: 106.8693},
                {id: 20, name: 'Warung Indah', area: 'Ancol', kecamatan: 'Pademangan', address: 'Jl. Ancol No. 107', phone: '021-1070107', contact: 'Bu Tuti', hours: '07:00 - 20:00', lat: -6.1225, lng: 106.8341}
            ];
            
            selectedStores = [];
            renderStores(storeData);
            updateCounter();
        }
        
        function renderStores(stores) {
            const storeList = document.getElementById('storeList');
            if (!storeList) return;
            
            storeList.innerHTML = stores.map(store => `
                <div class="store-compact ${selectedStores.includes(store.id) ? 'selected' : ''}" onclick="toggleStoreSelection(${store.id})">
                    <input type="checkbox" class="store-checkbox" ${selectedStores.includes(store.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleStoreSelection(${store.id})">
                    <div class="store-name">${store.name}</div>
                    <div class="store-area">${getAreaName(store.area)}</div>
                </div>
            `).join('');
            
            updateCounter();
        }
        
        function getAreaName(area) {
            const areas = {
                'jakarta-pusat': 'Jakpus',
                'jakarta-selatan': 'Jaksel',
                'jakarta-barat': 'Jakbar',
                'jakarta-timur': 'Jaktim',
                'jakarta-utara': 'Jakut'
            };
            return areas[area] || area;
        }
        
        function filterStores() {
            const searchTerm = document.getElementById('storeSearch').value.toLowerCase();
            let filteredStores = storeData;
            
            // Filter by kecamatan
            if (currentFilter !== 'semua') {
                filteredStores = filteredStores.filter(store => store.kecamatan === currentFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredStores = filteredStores.filter(store => 
                    store.name.toLowerCase().includes(searchTerm) ||
                    store.kecamatan.toLowerCase().includes(searchTerm)
                );
            }
            
            renderStores(filteredStores);
        }
        
        function filterByArea(area) {
            currentFilter = area;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            // Handle special cases for kecamatan names with spaces/special chars
            let buttonId = 'filter-semua';
            if (area !== 'semua') {
                buttonId = 'filter-' + area.toLowerCase().replace(/\s+/g, '-');
            }
            
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('active');
            }
            
            filterStores();
        }
        
        // Machine Learning Recommendation System
        function generateMLRecommendation() {
            const mlDiv = document.getElementById('mlRecommendation');
            mlDiv.innerHTML = '<p>üîÑ Menganalisis data sales dan pola kunjungan...</p>';
            
            // Simulate ML processing
            setTimeout(() => {
                const recommendation = analyzeCallPlanML();
                displayMLRecommendation(recommendation);
            }, 2000);
        }
        
        function analyzeCallPlanML() {
            // Simulate ML analysis based on sales patterns
            const salesHistory = getSalesHistoryData();
            const currentDay = new Date().getDay(); // 0=Sunday, 1=Monday, etc.
            const currentTime = new Date().getHours();
            
            // Analysis factors
            const analysis = {
                bestPerformingStores: [],
                timeOptimization: '',
                routeEfficiency: '',
                salesPotential: '',
                recommendations: []
            };
            
            // Find best performing stores by historical data
            analysis.bestPerformingStores = storeData
                .filter(store => store.salesHistory && store.salesHistory.avgOrderValue > 500000)
                .sort((a, b) => (b.salesHistory.avgOrderValue || 0) - (a.salesHistory.avgOrderValue || 0))
                .slice(0, 5);
            
            // Time-based recommendations
            if (currentTime >= 8 && currentTime <= 10) {
                analysis.timeOptimization = 'Waktu optimal untuk toko besar (pagi hari - owner biasanya hadir)';
            } else if (currentTime >= 13 && currentTime <= 15) {
                analysis.timeOptimization = 'Waktu optimal untuk toko menengah (siang - aktivitas tinggi)';
            } else {
                analysis.timeOptimization = 'Waktu optimal untuk toko kecil dan follow-up';
            }
            
            // Day-based recommendations
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            if (currentDay === 1 || currentDay === 2) { // Monday/Tuesday
                analysis.routeEfficiency = 'Mulai dari area terjauh untuk efisiensi minggu ini';
            } else if (currentDay === 5 || currentDay === 6) { // Friday/Saturday
                analysis.routeEfficiency = 'Fokus area dekat untuk closing order mingguan';
            } else {
                analysis.routeEfficiency = 'Seimbang antara prospek baru dan maintenance customer';
            }
            
            // Generate specific recommendations
            analysis.recommendations = [
                `üéØ Prioritas tinggi: ${analysis.bestPerformingStores.slice(0, 3).map(s => s.name).join(', ')}`,
                `‚è∞ ${analysis.timeOptimization}`,
                `üó∫Ô∏è ${analysis.routeEfficiency}`,
                `üìà Target hari ini: ${getCurrentTarget()} berdasarkan performa bulan lalu`,
                `üö© Hindari area yang macet jam ${getCurrentTrafficWarning()}`
            ];
            
            return analysis;
        }
        
        function getSalesHistoryData() {
            // Simulate historical sales data analysis
            return {
                totalVisits: 156,
                successRate: 68,
                avgOrderValue: 750000,
                bestDays: ['Selasa', 'Rabu', 'Kamis'],
                bestTimes: ['09:00-11:00', '14:00-16:00'],
                topAreas: ['Semampir', 'Gubeng', 'Wonokromo']
            };
        }
        
        function getCurrentTarget() {
            const targets = ['8-10 toko', '12-15 toko', '6-8 toko', '10-12 toko'];
            return targets[Math.floor(Math.random() * targets.length)];
        }
        
        function getCurrentTrafficWarning() {
            const currentHour = new Date().getHours();
            if (currentHour >= 7 && currentHour <= 9) return '07:00-09:00 (rush hour pagi)';
            if (currentHour >= 16 && currentHour <= 18) return '16:00-18:00 (rush hour sore)';
            return 'tidak ada peringatan khusus';
        }
        
        function displayMLRecommendation(analysis) {
            const mlDiv = document.getElementById('mlRecommendation');
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <h5>üìä Analisis Smart Call Plan</h5>
                    <div style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        ${analysis.recommendations.map(rec => `<p style="margin: 5px 0;">‚úÖ ${rec}</p>`).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <h5>üèÜ Top Performing Stores</h5>
                    <div style="background: white; padding: 10px; border-radius: 5px;">
                        ${analysis.bestPerformingStores.map(store => 
                            `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
                                <strong>${store.name}</strong> - ${store.address}
                                <br><small>Rata-rata order: Rp ${(store.salesHistory?.avgOrderValue || 0).toLocaleString('id-ID')}</small>
                            </div>`
                        ).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="applyMLRecommendation()" class="btn btn-primary" style="flex: 1;">
                        üéØ Terapkan Rekomendasi
                    </button>
                    <button onclick="generateMLRecommendation()" class="btn btn-outline-success" style="flex: 1;">
                        üîÑ Generate Ulang
                    </button>
                </div>
            `;
            
            mlDiv.innerHTML = html;
        }
        
        function applyMLRecommendation() {
            const analysis = analyzeCallPlanML();
            
            // Clear current selection
            selectedStores = [];
            
            // Auto-select top performing stores
            analysis.bestPerformingStores.forEach(store => {
                selectedStores.push(store.id);
            });
            
            // Apply smart filter based on time and day
            const currentHour = new Date().getHours();
            if (currentHour >= 8 && currentHour <= 10) {
                // Morning: focus on big stores
                storeData.filter(store => store.type === 'Toko Besar').forEach(store => {
                    if (!selectedStores.includes(store.id)) {
                        selectedStores.push(store.id);
                    }
                });
            }
            
            // Re-render with ML selections
            filterStores();
            
            alert(`ü§ñ Rekomendasi AI diterapkan!\n\n‚úÖ ${selectedStores.length} toko telah dipilih berdasarkan analisis machine learning\nüìä Prediksi success rate: 75-80%\nüéØ Estimasi pencapaian target: 85%`);
        }
        
        function toggleStoreSelection(storeId) {
            const index = selectedStores.indexOf(storeId);
            if (index > -1) {
                selectedStores.splice(index, 1);
            } else {
                selectedStores.push(storeId);
            }
            
            filterStores(); // Re-render with selection state
        }
        
        function selectAll() {
            const visibleStores = getVisibleStores();
            visibleStores.forEach(store => {
                if (!selectedStores.includes(store.id)) {
                    selectedStores.push(store.id);
                }
            });
            filterStores();
        }
        
        function clearSelection() {
            selectedStores = [];
            filterStores();
        }
        
        function getVisibleStores() {
            const searchTerm = document.getElementById('storeSearch').value.toLowerCase();
            let filteredStores = storeData;
            
            if (currentFilter !== 'semua') {
                filteredStores = filteredStores.filter(store => store.area === currentFilter);
            }
            
            if (searchTerm) {
                filteredStores = filteredStores.filter(store => 
                    store.name.toLowerCase().includes(searchTerm)
                );
            }
            
            return filteredStores;
        }
        
        function updateCounter() {
            const selectedCountEl = document.getElementById('selectedCount');
            const totalStoresEl = document.getElementById('totalStores');
            
            if (selectedCountEl) selectedCountEl.textContent = selectedStores.length;
            if (totalStoresEl) totalStoresEl.textContent = storeData.length;
        }

        // Get sales home location (simulated - in real app would be from database)
        function getSalesHomeLocation() {
            // This would come from sales profile in real implementation
            const salesProfiles = {
                'admin': {
                    name: 'Admin Sales',
                    address: 'Jl. Kebon Jeruk Raya No. 15, Kebon Jeruk, Jakarta Barat',
                    lat: -6.1944,
                    lng: 106.7831,
                    kecamatan: 'Kebon Jeruk'
                }
            };
            
            const currentUser = localStorage.getItem('currentUser') || 'admin';
            return salesProfiles[currentUser] || salesProfiles['admin'];
        }
        
        // Calculate distance from sales home to store
        function calculateDistanceFromHome(homeLocation, store) {
            // Simplified distance calculation (in real app would use proper GPS calculation)
            const latDiff = Math.abs(homeLocation.lat - (store.lat || -6.2));
            const lngDiff = Math.abs(homeLocation.lng - (store.lng || 106.8));
            const distance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff) * 111; // Rough km conversion
            return distance.toFixed(1);
        }

        // Generate Route
        function generateRoute() {
            if (selectedStores.length === 0) {
                alert('‚ùå Pilih minimal 1 toko untuk membuat rute!');
                return;
            }
            
            // Get current sales location (home address)
            const salesLocation = getSalesHomeLocation();
            
            const selectedStoreData = storeData.filter(store => selectedStores.includes(store.id));
            
            // Simulate route optimization starting from sales home
            const optimizedRoute = selectedStoreData.map((store, index) => ({
                ...store,
                sequence: index + 1,
                estimatedTime: Math.floor(Math.random() * 30) + 15, // 15-45 minutes
                distance: (Math.random() * 5 + 1).toFixed(1), // 1-6 km
                distanceFromPrevious: index === 0 ? 
                    calculateDistanceFromHome(salesLocation, store) : 
                    (Math.random() * 3 + 0.5).toFixed(1)
            }));
            
            const routeDisplay = document.getElementById('routeDisplay');
            const routeDetails = document.getElementById('routeDetails');
            
            routeDetails.innerHTML = `
                <div class="route-info">
                    <div class="start-location">
                        <strong>üìç Titik Mulai:</strong> ${salesLocation.address}<br>
                        <small>üè† Rumah Sales (GPS: ${salesLocation.lat}, ${salesLocation.lng})</small>
                    </div>
                </div>
                
                <div class="route-summary">
                    <div class="route-stat">
                        <span class="stat-label">üè™ Total Toko:</span>
                        <span class="stat-value">${optimizedRoute.length}</span>
                    </div>
                    <div class="route-stat">
                        <span class="stat-label">‚è±Ô∏è Est. Waktu:</span>
                        <span class="stat-value">${optimizedRoute.reduce((sum, store) => sum + store.estimatedTime, 0)} menit</span>
                    </div>
                    <div class="route-stat">
                        <span class="stat-label">üìè Total Jarak:</span>
                        <span class="stat-value">${optimizedRoute.reduce((sum, store) => sum + parseFloat(store.distance), 0).toFixed(1)} km</span>
                    </div>
                </div>
                
                <div class="route-list">
                    ${optimizedRoute.map(store => `
                        <div class="route-item">
                            <div class="route-sequence">${store.sequence}</div>
                            <div class="route-info">
                                <h5>${store.name}</h5>
                                <p>üìç ${store.address}</p>
                                <p>‚è±Ô∏è ${store.estimatedTime} menit | üìè ${store.distance} km</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            routeDisplay.classList.remove('hidden');
            currentRoute = optimizedRoute;
        }

        // Edit Route
        function editRoute() {
            document.getElementById('routeDisplay').classList.add('hidden');
            alert('‚úèÔ∏è Silahkan edit pilihan toko dan generate rute lagi');
        }

        // Fix Call Plan
        function fixCallPlan() {
            if (!currentRoute || currentRoute.length === 0) {
                alert('‚ùå Belum ada rute yang dibuat!');
                return;
            }
            
            callPlanCreated = true;
            
            alert(`‚úÖ Call Plan berhasil di-fix!\nüó∫Ô∏è Rute ${currentRoute.length} toko siap untuk dikunjungi\n\nüìã Detail:\n${currentRoute.map(store => `${store.sequence}. ${store.name}`).join('\n')}`);
            
            // Update dashboard buttons
            updateDashboardButtons();
            
            // Hide route display
            document.getElementById('routeDisplay').classList.add('hidden');
            
            // Go back to dashboard
            showDashboard();
        }

        // Show Tagihan
        function showTagihan() {
            if (!callPlanCreated) {
                alert('‚ùå Buat Call Plan terlebih dahulu!');
                return;
            }
            
            const content = `
                <div class="section-title">üí≥ Dashboard Tagihan</div>
                
                <div class="search-section">
                    <input type="text" id="tagihanSearch" class="form-input" placeholder="üîç Cari nama toko atau nomor faktur..." onkeyup="filterTagihan()">
                    <div class="filter-buttons">
                        <button onclick="filterTagihanByStatus('semua')" class="filter-btn active" id="filter-semua">Semua</button>
                        <button onclick="filterTagihanByStatus('terlambat')" class="filter-btn" id="filter-terlambat">Terlambat</button>
                        <button onclick="filterTagihanByStatus('lancar')" class="filter-btn" id="filter-lancar">Lancar</button>
                        <button onclick="filterTagihanByStatus('wajib-tagih')" class="filter-btn" id="filter-wajib">ÔøΩ Wajib Tagih</button>
                    </div>
                </div>
                
                <div class="toko-selector-section" style="margin: 15px 0;">
                    <label for="tokoSelect" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">üè™ Pilih Toko (Call Plan):</label>
                    <select id="tokoSelect" class="form-input" onchange="filterByToko()" style="width: 100%; padding: 10px;">
                        <option value="">-- Pilih Toko --</option>
                        <!-- Options will be populated dynamically based on toko groups in DOM -->
                    </select>
                </div>
                
                <div class="tagihan-counter">
                    <span id="tagihanCount">0</span> faktur dari <span id="tokoCount">0</span> toko
                </div>
                
                <div class="tagihan-list" id="tagihanList">
                    <!-- Toko Sari Rasa - Multiple Invoices -->
                    <div class="toko-group" data-toko="Toko Sari Rasa">
                        <div class="toko-header" onclick="toggleTokoGroup(this)">
                            <h4>üè™ Toko Sari Rasa</h4>
                            <div class="toko-summary">
                                <span class="invoice-count">3 faktur</span>
                                <span class="total-amount">Rp 6.750.000</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="toko-invoices">
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-001', 2500000, 'Toko Sari Rasa')" data-invoice="INV-2025-001" data-amount="2500000" data-toko="Toko Sari Rasa" data-date="2025-07-20">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-001</span>
                                        <span class="tagihan-status status-wajib-tagih">üö® Wajib Tagih</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-07-20 (53 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.500.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash/Transfer/QRIS</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 30 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù BCA: 1234567890</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-005', 1750000, 'Toko Sari Rasa')" data-invoice="INV-2025-005" data-amount="1750000" data-toko="Toko Sari Rasa" data-date="2025-09-01">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">ÔøΩ INV-2025-005</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-01 (9 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.750.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash/Cek/Giro</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 45 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù Min cek: Rp 1.000.000</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-009', 2500000, 'Toko Sari Rasa')" data-invoice="INV-2025-009" data-amount="2500000" data-toko="Toko Sari Rasa" data-date="2025-09-08">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-009</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-08 (2 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.500.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Transfer/QRIS</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 30 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù Mandiri: 0987654321</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Warung Maju Jaya - Multiple Invoices -->
                    <div class="toko-group" data-toko="Warung Maju Jaya">
                        <div class="toko-header" onclick="toggleTokoGroup(this)">
                            <h4>üè™ Warung Maju Jaya</h4>
                            <div class="toko-summary">
                                <span class="invoice-count">2 faktur</span>
                                <span class="total-amount">Rp 3.950.000</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="toko-invoices">
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-002', 1750000, 'Warung Maju Jaya')" data-invoice="INV-2025-002" data-amount="1750000" data-toko="Warung Maju Jaya" data-date="2025-09-01">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-002</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-01 (9 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.750.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash/Transfer/Cek</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 60 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù BNI: 5678901234</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-006', 2200000, 'Warung Maju Jaya')" data-invoice="INV-2025-006" data-amount="2200000" data-toko="Warung Maju Jaya" data-date="2025-08-20">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">ÔøΩ INV-2025-006</span>
                                        <span class="tagihan-status status-terlambat">‚ö†Ô∏è Terlambat</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-07-25 (48 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.200.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash Only</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 14 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù Langsung ke kasir</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toko Berkah - Single Invoice -->
                    <div class="toko-group" data-toko="Toko Berkah">
                        <div class="toko-header" onclick="toggleTokoGroup(this)">
                            <h4>üè™ Toko Berkah</h4>
                            <div class="toko-summary">
                                <span class="invoice-count">1 faktur</span>
                                <span class="total-amount">Rp 3.200.000</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="toko-invoices">
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-003', 3200000, 'Toko Berkah')">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-003</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-05 (5 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 3.200.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Transfer/OVO/DANA</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 30 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù E-wallet: 081234567890</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Minimarket Sejahtera - Multiple Invoices -->
                    <div class="toko-group" data-toko="Minimarket Sejahtera">
                        <div class="toko-header" onclick="toggleTokoGroup(this)">
                            <h4>üè™ Minimarket Sejahtera</h4>
                            <div class="toko-summary">
                                <span class="invoice-count">4 faktur</span>
                                <span class="total-amount">Rp 8.750.000</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="toko-invoices">
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-004', 1500000, 'Minimarket Sejahtera')">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-004</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-08 (2 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.500.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash/Transfer/QRIS</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 30 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù BCA: 1234567890</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-007', 2250000, 'Minimarket Sejahtera')">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-007</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-03 (7 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.250.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash/Cek/Giro</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 45 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù Min cek: Rp 1.000.000</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-008', 3000000, 'Minimarket Sejahtera')">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-008</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-08-18 (23 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 3.000.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Transfer/QRIS</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 30 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù Mandiri: 0987654321</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-010', 2000000, 'Minimarket Sejahtera')">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-010</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-07 (3 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.000.000</span>
                                    </div>
                                    <div class="payment-terms">
                                        <span class="payment-method-info">üí≥ Ketentuan: Cash/Transfer/Cek</span>
                                        <span class="payment-due">‚è∞ Jatuh tempo: 60 hari</span>
                                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">üìù BNI: 5678901234</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toko Sari Bumi - 5 Faktur sesuai contoh -->
                    <div class="toko-group" data-toko="Toko Sari Bumi">
                        <div class="toko-header" onclick="toggleTokoGroup(this)">
                            <h4>üè™ Toko Sari Bumi</h4>
                            <div class="toko-summary">
                                <span class="invoice-count">5 faktur</span>
                                <span class="total-amount">Rp 8.500.000</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="toko-invoices">
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-011', 1500000, 'Toko Sari Bumi')" data-invoice="INV-2025-011" data-amount="1500000" data-toko="Toko Sari Bumi" data-date="2025-09-05">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-011</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-05 (5 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.500.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-012', 1500000, 'Toko Sari Bumi')" data-invoice="INV-2025-012" data-amount="1500000" data-toko="Toko Sari Bumi" data-date="2025-09-06">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-012</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-06 (4 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.500.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-013', 2000000, 'Toko Sari Bumi')" data-invoice="INV-2025-013" data-amount="2000000" data-toko="Toko Sari Bumi" data-date="2025-08-25">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-013</span>
                                        <span class="tagihan-status status-terlambat">‚ö†Ô∏è Terlambat</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-08-25 (16 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.000.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-014', 1500000, 'Toko Sari Bumi')" data-invoice="INV-2025-014" data-amount="1500000" data-toko="Toko Sari Bumi" data-date="2025-09-07">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-014</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-07 (3 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.500.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-015', 2500000, 'Toko Sari Bumi')" data-invoice="INV-2025-015" data-amount="2500000" data-toko="Toko Sari Bumi" data-date="2025-09-08">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-015</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-08 (2 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.500.000</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toko Samudra - 6 Nota sesuai contoh -->
                    <div class="toko-group" data-toko="Toko Samudra">
                        <div class="toko-header" onclick="toggleTokoGroup(this)">
                            <h4>üè™ Toko Samudra</h4>
                            <div class="toko-summary">
                                <span class="invoice-count">6 nota</span>
                                <span class="total-amount">Rp 12.000.000</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="toko-invoices">
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-016', 2000000, 'Toko Samudra')" data-invoice="INV-2025-016" data-amount="2000000" data-toko="Toko Samudra" data-date="2025-09-03">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-016</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-03 (7 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.000.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-017', 2000000, 'Toko Samudra')" data-invoice="INV-2025-017" data-amount="2000000" data-toko="Toko Samudra" data-date="2025-09-04">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-017</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-04 (6 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.000.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-018', 1500000, 'Toko Samudra')" data-invoice="INV-2025-018" data-amount="1500000" data-toko="Toko Samudra" data-date="2025-08-20">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-018</span>
                                        <span class="tagihan-status status-terlambat">‚ö†Ô∏è Terlambat</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-08-20 (21 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.500.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-019', 2500000, 'Toko Samudra')" data-invoice="INV-2025-019" data-amount="2500000" data-toko="Toko Samudra" data-date="2025-09-06">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-019</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-06 (4 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 2.500.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-020', 1000000, 'Toko Samudra')" data-invoice="INV-2025-020" data-amount="1000000" data-toko="Toko Samudra" data-date="2025-09-08">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-020</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-08 (2 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 1.000.000</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tagihan-item" onclick="selectTagihan(this, 'INV-2025-021', 3000000, 'Toko Samudra')" data-invoice="INV-2025-021" data-amount="3000000" data-toko="Toko Samudra" data-date="2025-09-09">
                                <input type="checkbox" class="invoice-checkbox" onclick="toggleInvoiceSelection(event, this)" style="display: none;">
                                <div class="invoice-info">
                                    <div class="invoice-main">
                                        <span class="invoice-number">üìÑ INV-2025-021</span>
                                        <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                                    </div>
                                    <div class="invoice-details">
                                        <span>üìÖ 2025-09-09 (1 hari)</span>
                                        <span class="invoice-amount">üí∞ Rp 3.000.000</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="paymentForm" class="payment-form">
                    <h4>üí≥ Form Pembayaran</h4>
                    <div id="selectedBill"></div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmount" class="form-input" placeholder="Masukkan jumlah pembayaran" onkeyup="validatePaymentAmount()">
                        <small id="paymentValidation" class="payment-validation"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jenis Pembayaran</label>
                        <div class="payment-type-section">
                            <button type="button" id="lunasBtn" class="payment-type-btn" onclick="setPaymentType('lunas')">‚úÖ Lunas</button>
                            <button type="button" id="titipBtn" class="payment-type-btn" onclick="setPaymentType('titip')">üì¶ Titip</button>
                        </div>
                        <input type="hidden" id="selectedPaymentType" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí≥ Metode Pembayaran</label>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'cash')">üíµ Cash</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'transfer')">üè¶ Transfer</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'cek')">üìÑ Cek</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'giro')">üìã Giro</div>
                        </div>
                    </div>
                    
                    <div id="fileUploadSection" class="file-upload hidden" onclick="document.getElementById('paymentProof').click()">
                        <p>üì∏ Upload Bukti Pembayaran</p>
                        <small>Klik untuk upload foto bukti transfer/cek/giro</small>
                        <input type="file" id="paymentProof" accept="image/*" style="display: none;">
                    </div>
                    
                    <button onclick="submitPayment()" class="btn btn-success">‚úÖ Proses Pembayaran</button>
                    <button onclick="hidePaymentForm()" class="btn btn-secondary">‚ùå Batal</button>
                </div>
                
                <style>
                .search-section {
                    margin-bottom: 20px;
                }
                
                .filter-buttons {
                    display: flex;
                    gap: 8px;
                    margin-top: 10px;
                }
                
                .filter-btn {
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 20px;
                    background: white;
                    color: #666;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                
                .filter-btn.active {
                    background: #667eea;
                    color: white;
                    border-color: #667eea;
                }
                
                .tagihan-counter {
                    background: #e3f2fd;
                    padding: 10px;
                    border-radius: 8px;
                    text-align: center;
                    font-weight: 600;
                    margin-bottom: 15px;
                    color: #1976d2;
                }
                
                .toko-group {
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    overflow: hidden;
                }
                
                .toko-header {
                    background: #f8f9fa;
                    padding: 15px;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #e9ecef;
                    transition: background 0.3s;
                }
                
                .toko-header:hover {
                    background: #e9ecef;
                }
                
                .toko-header h4 {
                    margin: 0;
                    font-size: 16px;
                    color: #333;
                }
                
                .toko-summary {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-size: 12px;
                }
                
                .invoice-count {
                    background: #667eea;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-weight: 600;
                }
                
                .total-amount {
                    color: #28a745;
                    font-weight: 600;
                }
                
                .expand-icon {
                    font-size: 12px;
                    color: #666;
                    transition: transform 0.3s;
                }
                
                .toko-group.collapsed .expand-icon {
                    transform: rotate(-90deg);
                }
                
                .toko-invoices {
                    background: white;
                    transition: max-height 0.3s ease-in-out;
                    overflow: hidden;
                }
                
                .toko-group.collapsed .toko-invoices {
                    max-height: 0;
                    border-top: none;
                }
                
                .tagihan-item {
                    padding: 12px 15px;
                    border-bottom: 1px solid #f1f3f4;
                    cursor: pointer;
                    transition: background 0.3s;
                    border-left: 4px solid transparent;
                }
                
                .tagihan-item:hover {
                    background: #f8f9fa;
                }
                
                .tagihan-item.selected {
                    background: #e3f2fd;
                    border-left-color: #2196f3;
                }
                
                .tagihan-item:last-child {
                    border-bottom: none;
                }
                
                .invoice-info {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }
                
                .invoice-main {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .invoice-number {
                    font-weight: 600;
                    color: #333;
                    font-size: 14px;
                }
                
                .invoice-details {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 12px;
                    color: #666;
                }
                
                .invoice-amount {
                    font-weight: 600;
                    color: #28a745;
                }
                
                .payment-terms {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 11px;
                    color: #666;
                    margin-top: 4px;
                    padding-top: 4px;
                    border-top: 1px solid #eee;
                }
                
                .payment-method-info {
                    color: #17a2b8;
                    font-weight: 500;
                }
                
                .payment-due {
                    color: #fd7e14;
                    font-weight: 500;
                }
                
                .payment-form-container {
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    margin: 20px 0;
                }
                
                .selected-invoice {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                    border-left: 4px solid #007bff;
                }
                
                .selected-invoice h4 {
                    margin: 0 0 8px 0;
                    color: #007bff;
                }
                
                .selected-invoice p {
                    margin: 4px 0;
                    color: #666;
                }
                
                .payment-type-section {
                    display: flex;
                    gap: 10px;
                    margin-top: 5px;
                }
                
                .payment-type-btn {
                    flex: 1;
                    padding: 12px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }
                
                .payment-type-btn.active {
                    background: #667eea;
                    color: white;
                    border-color: #667eea;
                }
                
                .payment-type-btn.disabled {
                    background: #f8f9fa;
                    color: #6c757d;
                    border-color: #dee2e6;
                    cursor: not-allowed;
                }
                
                .payment-validation {
                    margin-top: 5px;
                    font-size: 12px;
                    font-weight: 600;
                }
                
                .payment-validation.valid {
                    color: #28a745;
                }
                
                .payment-validation.invalid {
                    color: #dc3545;
                }
                </style>
            `;
            
            showContent(content);
            loadTagihanData();
            
            // Update toko selector counts after DOM is ready
            setTimeout(() => {
                updateTokoSelectorCounts();
                console.log('Toko selector counts updated');
            }, 100);
            
            // Add payment terms to all invoices after content is loaded
            setTimeout(() => {
                console.log('Adding payment terms to invoices...');
                addPaymentTermsToInvoices();
                console.log('Payment terms added successfully');
            }, 500); // Increase timeout to ensure DOM is ready
        }

        // Select Tagihan
        // Tagihan management functions
        function loadTagihanData() {
            // Hide all paid invoices from localStorage
            const paidInvoices = getPaidInvoices();
            console.log('Loading tagihan data. Paid invoices:', paidInvoices);
            
            paidInvoices.forEach(invoiceNo => {
                const invoiceItems = document.querySelectorAll(`[data-invoice="${invoiceNo}"]`);
                invoiceItems.forEach(item => {
                    item.remove(); // Langsung hapus dari DOM
                    console.log('Removed paid invoice from DOM:', invoiceNo);
                });
            });
            
            // Update toko group headers (count and total amount)
            const tokoGroups = document.querySelectorAll('.toko-group');
            tokoGroups.forEach(group => {
                const remainingInvoices = group.querySelectorAll('.tagihan-item');
                const invoiceCountEl = group.querySelector('.invoice-count');
                const totalAmountEl = group.querySelector('.total-amount');
                
                if (remainingInvoices.length === 0) {
                    // Jika tidak ada invoice tersisa, sembunyikan toko
                    group.style.display = 'none';
                    console.log('Hidden empty toko group');
                } else {
                    // Update jumlah nota
                    const count = remainingInvoices.length;
                    if (invoiceCountEl) {
                        invoiceCountEl.textContent = `${count} faktur`;
                    }
                    
                    // Update total nominal
                    let totalAmount = 0;
                    remainingInvoices.forEach(invoice => {
                        const amount = parseInt(invoice.dataset.amount) || 0;
                        totalAmount += amount;
                    });
                    
                    if (totalAmountEl) {
                        totalAmountEl.textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
                    }
                    
                    console.log(`Updated toko group: ${count} invoices, total: Rp ${totalAmount.toLocaleString('id-ID')}`);
                }
            });
            
            updateTagihanCounter();
            updateTokoSelectorCounts(); // Update dropdown counts
            
            // Update invoice displays for partial payments
            setTimeout(() => {
                updateAllInvoiceDisplays();
            }, 200);
        }
        
        // Update all invoice displays to show remaining amounts
        function updateAllInvoiceDisplays() {
            const allInvoices = document.querySelectorAll('.tagihan-item');
            allInvoices.forEach(item => {
                const invoiceNo = item.dataset.invoice;
                const originalAmount = parseInt(item.getAttribute('data-original-amount') || item.dataset.amount);
                
                // Store original amount if not already stored
                if (!item.getAttribute('data-original-amount')) {
                    item.setAttribute('data-original-amount', originalAmount);
                }
                
                const totalPaid = getTotalPaidForInvoice(invoiceNo);
                const remainingAmount = getInvoiceRemainingAmount(invoiceNo, originalAmount);
                
                if (totalPaid > 0 && remainingAmount > 0) {
                    // Update display for partially paid invoices
                    const amountEl = item.querySelector('.invoice-amount');
                    if (amountEl) {
                        amountEl.innerHTML = `üí∞ <span style="text-decoration: line-through; color: #999;">Rp ${originalAmount.toLocaleString('id-ID')}</span><br><span style="color: #f39c12; font-weight: bold;">Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}</span>`;
                    }
                    
                    // Update data-amount for calculations
                    item.dataset.amount = remainingAmount;
                    
                    // Add visual indicator
                    item.style.borderLeft = '4px solid #f39c12';
                    const statusEl = item.querySelector('.tagihan-status');
                    if (statusEl && !statusEl.textContent.includes('Cicilan')) {
                        statusEl.innerHTML = 'üí∞ Cicilan';
                        statusEl.style.background = '#f39c12';
                        statusEl.style.color = 'white';
                    }
                }
            });
            
            // Update all toko group totals
            const tokoGroups = document.querySelectorAll('.toko-group');
            tokoGroups.forEach(group => {
                updateTokoGroupTotals(group);
            });
        }

        function toggleTokoGroup(header) {
            const tokoGroup = header.parentElement;
            tokoGroup.classList.toggle('collapsed');
        }
        
        function filterTagihan() {
            const searchTerm = document.getElementById('tagihanSearch').value.toLowerCase();
            const tokoGroups = document.querySelectorAll('.toko-group');
            
            tokoGroups.forEach(group => {
                const tokoName = group.dataset.toko.toLowerCase();
                const invoices = group.querySelectorAll('.tagihan-item');
                let hasVisibleInvoice = false;
                
                invoices.forEach(invoice => {
                    const invoiceNumber = invoice.querySelector('.invoice-number').textContent.toLowerCase();
                    const isVisible = tokoName.includes(searchTerm) || invoiceNumber.includes(searchTerm);
                    
                    invoice.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) hasVisibleInvoice = true;
                });
                
                group.style.display = hasVisibleInvoice ? 'block' : 'none';
            });
            
            updateTagihanCounter();
        }
        
        function filterTagihanByStatus(status) {
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            // Handle the special case for wajib-tagih button
            if (status === 'wajib-tagih') {
                document.getElementById('filter-wajib').classList.add('active');
            } else {
                document.getElementById('filter-' + status).classList.add('active');
            }
            
            const tokoGroups = document.querySelectorAll('.toko-group');
            
            tokoGroups.forEach(group => {
                const invoices = group.querySelectorAll('.tagihan-item');
                let hasVisibleInvoice = false;
                
                invoices.forEach(invoice => {
                    const statusElement = invoice.querySelector('.tagihan-status');
                    const statusText = statusElement.textContent;
                    
                    let invoiceStatus = 'lancar';
                    if (statusText.includes('Wajib Tagih')) {
                        invoiceStatus = 'wajib-tagih';
                    } else if (statusText.includes('Terlambat')) {
                        invoiceStatus = 'terlambat';
                    }
                    
                    const isVisible = status === 'semua' || invoiceStatus === status;
                    
                    invoice.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) hasVisibleInvoice = true;
                });
                
                group.style.display = hasVisibleInvoice ? 'block' : 'none';
            });
            
            updateTagihanCounter();
        }
        
        function updateTagihanCounter() {
            const visibleInvoices = document.querySelectorAll('.tagihan-item[style="display: block"], .tagihan-item:not([style*="display: none"])');
            const visibleStores = document.querySelectorAll('.toko-group[style="display: block"], .toko-group:not([style*="display: none"])');
            
            const tagihanCountEl = document.getElementById('tagihanCount');
            const tokoCountEl = document.getElementById('tokoCount');
            
            if (tagihanCountEl) tagihanCountEl.textContent = visibleInvoices.length;
            if (tokoCountEl) tokoCountEl.textContent = visibleStores.length;
        }
        
        // Filter tagihan by selected toko
        function filterByToko() {
            const selectedToko = document.getElementById('tokoSelect').value;
            const tokoGroups = document.querySelectorAll('.toko-group');
            
            console.log('Filtering by toko:', selectedToko);
            
            tokoGroups.forEach(group => {
                const tokoName = group.dataset.toko;
                
                if (selectedToko === '' || tokoName === selectedToko) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            });
            
            // Reset selected invoices when changing toko
            selectedInvoices = [];
            batchTotalAmount = 0;
            document.querySelectorAll('.tagihan-item').forEach(item => {
                item.classList.remove('selected', 'batch-selected');
            });
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                cb.checked = false;
                cb.style.display = 'none';
            });
            
            // Hide payment form
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm) {
                paymentForm.style.display = 'none';
            }
            
            updateTagihanCounter();
        }
        
        // Function to add payment terms to all invoices
        function addPaymentTermsToInvoices() {
            console.log('Function addPaymentTermsToInvoices called');
            const invoiceItems = document.querySelectorAll('.tagihan-item');
            console.log('Found invoice items:', invoiceItems.length);
            
            invoiceItems.forEach((item, index) => {
                const invoiceInfo = item.querySelector('.invoice-info');
                const invoiceDetails = item.querySelector('.invoice-details');
                
                console.log(`Processing invoice ${index}:`, invoiceInfo ? 'found' : 'not found');
                
                // Check if payment terms already exist
                if (!item.querySelector('.payment-terms')) {
                    const paymentTerms = document.createElement('div');
                    paymentTerms.className = 'payment-terms';
                    
                    // Define different payment terms for variety with more detail
                    const paymentMethods = [
                        { method: 'Cash/Transfer/QRIS', due: '30 hari', detail: 'BCA: 1234567890' },
                        { method: 'Cash/Cek/Giro', due: '45 hari', detail: 'Min cek: Rp 1.000.000' },
                        { method: 'Transfer/QRIS', due: '30 hari', detail: 'Mandiri: 0987654321' },
                        { method: 'Cash/Transfer/Cek', due: '60 hari', detail: 'BNI: 5678901234' },
                        { method: 'Cash Only', due: '14 hari', detail: 'Langsung ke kasir' },
                        { method: 'Transfer/OVO/DANA', due: '30 hari', detail: 'E-wallet: 081234567890' }
                    ];
                    
                    const termIndex = index % paymentMethods.length;
                    const term = paymentMethods[termIndex];
                    
                    paymentTerms.innerHTML = `
                        <span class="payment-method-info">üí≥ Ketentuan: ${term.method}</span>
                        <span class="payment-due">‚è∞ Jatuh tempo: ${term.due}</span>
                        <div class="payment-detail" style="font-size: 10px; color: #777; margin-top: 2px;">
                            üìù ${term.detail}
                        </div>
                    `;
                    
                    // Insert after invoice-details
                    if (invoiceDetails && invoiceInfo) {
                        invoiceInfo.appendChild(paymentTerms);
                        console.log(`Payment terms added to invoice ${index}`);
                    } else {
                        console.log(`Could not add payment terms to invoice ${index} - missing elements`);
                    }
                }
            });
        }
        
        // Global variables for payment validation
        let currentInvoiceAmount = 0;
        let currentInvoiceNo = '';
        let currentTokoName = '';
        let selectedInvoices = []; // Array untuk menyimpan faktur yang dipilih
        let selectedInvoice = null; // Single invoice yang dipilih
        let batchTotalAmount = 0;
        
        // LocalStorage untuk menyimpan invoice yang sudah lunas
        function getPaidInvoices() {
            const paid = localStorage.getItem('paidInvoices');
            return paid ? JSON.parse(paid) : [];
        }
        
        function addPaidInvoice(invoiceNo) {
            const paidInvoices = getPaidInvoices();
            if (!paidInvoices.includes(invoiceNo)) {
                paidInvoices.push(invoiceNo);
                localStorage.setItem('paidInvoices', JSON.stringify(paidInvoices));
                console.log('Invoice marked as paid:', invoiceNo);
                console.log('All paid invoices:', paidInvoices);
            }
        }
        
        function isInvoicePaid(invoiceNo) {
            return getPaidInvoices().includes(invoiceNo);
        }
        
        // LocalStorage untuk menyimpan pembayaran cicilan
        function getInvoicePayments() {
            const payments = localStorage.getItem('invoicePayments');
            return payments ? JSON.parse(payments) : {};
        }
        
        function addInvoicePayment(invoiceNo, amount, originalAmount) {
            const payments = getInvoicePayments();
            
            if (!payments[invoiceNo]) {
                payments[invoiceNo] = {
                    originalAmount: originalAmount,
                    totalPaid: 0,
                    paymentHistory: []
                };
            }
            
            payments[invoiceNo].totalPaid += amount;
            payments[invoiceNo].paymentHistory.push({
                amount: amount,
                date: new Date().toISOString(),
                timestamp: new Date().toLocaleString('id-ID')
            });
            
            localStorage.setItem('invoicePayments', JSON.stringify(payments));
            console.log(`Payment recorded for ${invoiceNo}: Rp ${amount.toLocaleString('id-ID')}`);
            return payments[invoiceNo];
        }
        
        function getInvoiceRemainingAmount(invoiceNo, originalAmount) {
            const payments = getInvoicePayments();
            if (!payments[invoiceNo]) {
                return originalAmount;
            }
            const remaining = originalAmount - payments[invoiceNo].totalPaid;
            return remaining > 0 ? remaining : 0;
        }
        
        function getTotalPaidForInvoice(invoiceNo) {
            const payments = getInvoicePayments();
            return payments[invoiceNo] ? payments[invoiceNo].totalPaid : 0;
        }
        
        // Function to count unpaid invoices for a toko
        function getUnpaidInvoiceCountForToko(tokoName) {
            // Cari toko group berdasarkan nama toko
            const tokoGroups = document.querySelectorAll('.toko-group');
            let targetGroup = null;
            
            tokoGroups.forEach(group => {
                if (group.dataset.toko === tokoName) {
                    targetGroup = group;
                }
            });
            
            if (!targetGroup) {
                console.log(`Toko group not found for: ${tokoName}`);
                return 0;
            }
            
            // Hitung semua invoice yang masih ada di DOM (belum dihapus)
            const remainingInvoices = targetGroup.querySelectorAll('.tagihan-item');
            const count = remainingInvoices.length;
            
            console.log(`Counting invoices for ${tokoName}: ${count} unpaid invoices remaining in DOM`);
            return count;
        }
        
        // Function to update toko selector dropdown with correct invoice counts
        function updateTokoSelectorCounts() {
            const tokoSelect = document.getElementById('tokoSelect');
            if (!tokoSelect) {
                console.log('Toko selector not found');
                return;
            }
            
            // Get all toko groups from DOM (yang punya invoice)
            const tokoGroups = document.querySelectorAll('.toko-group');
            
            // Clear existing options except the first one (-- Pilih Toko --)
            while (tokoSelect.options.length > 1) {
                tokoSelect.remove(1);
            }
            
            // Build options dynamically based on toko groups in DOM
            tokoGroups.forEach(group => {
                const tokoName = group.dataset.toko;
                if (!tokoName) return;
                
                // Count unpaid invoices for this toko
                const count = getUnpaidInvoiceCountForToko(tokoName);
                
                // Only show toko if it has invoices
                if (count > 0) {
                    const option = document.createElement('option');
                    option.value = tokoName;
                    option.dataset.toko = tokoName;
                    option.textContent = `üè™ ${tokoName} (${count} faktur)`;
                    tokoSelect.appendChild(option);
                    console.log(`Added to selector: ${tokoName} with ${count} invoices`);
                }
            });
            
            console.log('Toko selector dropdown updated');
        }

        // Auto-detect payment mode based on selected invoices
        function getPaymentMode() {
            return selectedInvoices.length > 1 ? 'batch' : 'single';
        }

        // Update checkbox visibility based on selection count
        function updateCheckboxVisibility() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            checkboxes.forEach(cb => {
                cb.style.display = selectedInvoices.length > 0 ? 'inline-block' : 'none';
            });
        }

        // Update batch counter display
        function updateBatchCounter() {
            const counterEl = document.getElementById('tagihanCount');
            if (selectedInvoices.length > 1) {
                counterEl.innerHTML = `${selectedInvoices.length} faktur dipilih - Total: Rp ${batchTotalAmount.toLocaleString('id-ID')}`;
            } else if (selectedInvoices.length === 1) {
                counterEl.innerHTML = `1 faktur dipilih - Total: Rp ${selectedInvoices[0].amount.toLocaleString('id-ID')}`;
            }
        }

        // Toggle invoice selection for automatic single/batch mode
        function toggleInvoiceSelection(event, checkbox) {
            event.stopPropagation();
            
            console.log('toggleInvoiceSelection called:', checkbox.checked);
            
            const item = checkbox.closest('.tagihan-item');
            const invoice = item.dataset.invoice;
            const amount = parseInt(item.dataset.amount);
            const toko = item.dataset.toko;
            const date = item.dataset.date;
            
            console.log('Invoice data:', {invoice, amount, toko, date});
            
            if (checkbox.checked) {
                // Add to selection
                selectedInvoices.push({
                    invoice: invoice,
                    amount: amount,
                    toko: toko,
                    date: date,
                    element: item
                });
                batchTotalAmount += amount;
                item.classList.add('batch-selected');
                console.log('Added to selection. Total invoices:', selectedInvoices.length);
            } else {
                // Remove from selection
                selectedInvoices = selectedInvoices.filter(inv => inv.invoice !== invoice);
                batchTotalAmount -= amount;
                item.classList.remove('batch-selected');
                console.log('Removed from selection. Total invoices:', selectedInvoices.length);
            }
            
            // Update checkbox visibility
            updateCheckboxVisibility();
            updateBatchCounter();
            
            // Show payment form based on selection count
            if (selectedInvoices.length === 1) {
                // Single invoice selected
                const inv = selectedInvoices[0];
                currentInvoiceAmount = inv.amount;
                currentInvoiceNo = inv.invoice;
                currentTokoName = inv.toko;
                
                document.getElementById('paymentForm').style.display = 'block';
                document.getElementById('selectedBill').innerHTML = `<strong>Toko:</strong> ${inv.toko}<br><strong>Faktur:</strong> ${inv.invoice}<br><strong>Total Faktur:</strong> Rp ${inv.amount.toLocaleString('id-ID')}`;
                
                console.log('Single invoice mode');
            } else if (selectedInvoices.length > 1) {
                // Multiple invoices selected - batch mode
                console.log('Batch payment mode');
                showBatchPaymentForm();
            } else {
                // No invoices selected
                console.log('No invoices selected');
                const paymentForm = document.getElementById('paymentForm');
                if (paymentForm) {
                    paymentForm.style.display = 'none';
                }
            }
            
            // Reset form when selection changes
            document.getElementById('paymentAmount').value = '';
            document.getElementById('selectedPaymentType').value = '';
            document.querySelectorAll('.payment-type-btn').forEach(btn => {
                btn.classList.remove('active', 'disabled');
            });
            document.getElementById('paymentValidation').innerHTML = '';
        }

        // Update batch counter display
        function updateBatchCounter() {
            const counterEl = document.getElementById('tagihanCount');
            if (paymentMode === 'batch' && selectedInvoices.length > 0) {
                counterEl.innerHTML = `${selectedInvoices.length} faktur dipilih - Total: Rp ${batchTotalAmount.toLocaleString('id-ID')}`;
            }
        }
        
        function selectTagihan(element, invoiceNo, amount, tokoName) {
            console.log('selectTagihan called for:', invoiceNo, 'amount param:', amount);
            
            // Get original amount - prioritize data-original-amount, fallback to current amount
            let originalAmount = parseInt(element.getAttribute('data-original-amount'));
            
            // If data-original-amount doesn't exist or is NaN, use amount parameter
            if (isNaN(originalAmount) || !originalAmount) {
                originalAmount = parseInt(amount);
                // Store it for future use
                element.setAttribute('data-original-amount', originalAmount);
            }
            
            const totalPaid = getTotalPaidForInvoice(invoiceNo);
            const remainingAmount = getInvoiceRemainingAmount(invoiceNo, originalAmount);
            
            console.log(`Invoice ${invoiceNo}: Original Rp ${originalAmount.toLocaleString('id-ID')}, Paid Rp ${totalPaid.toLocaleString('id-ID')}, Remaining Rp ${remainingAmount.toLocaleString('id-ID')}`);
            
            // Store selected invoice data with original amount
            selectedInvoice = {
                number: invoiceNo,
                amount: originalAmount,  // Store original amount for calculations
                remainingAmount: remainingAmount > 0 ? remainingAmount : originalAmount,  // Store remaining for display
                totalPaid: totalPaid,  // Store already paid amount
                toko: tokoName,
                element: element
            };
            
            // Show payment form dengan auto-detect mode
            const currentPaymentMode = getPaymentMode();
            
            if (currentPaymentMode === 'batch') {
                console.log('Batch payment mode');
                showBatchPaymentForm();
            } else {
                console.log('Single payment mode');
                showSinglePaymentForm();
            }
        }
        
        // Show single payment form
        function showSinglePaymentForm() {
            // Build payment info display
            let paymentInfo = `<p>üí∞ Total Faktur: Rp ${selectedInvoice.amount.toLocaleString('id-ID')}</p>`;
            
            if (selectedInvoice.totalPaid > 0) {
                paymentInfo += `<p style="color: #f39c12;">üìä Sudah Dibayar: Rp ${selectedInvoice.totalPaid.toLocaleString('id-ID')}</p>`;
                paymentInfo += `<p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è Sisa Tagihan: Rp ${selectedInvoice.remainingAmount.toLocaleString('id-ID')}</p>`;
            }
            
            const content = `
                <div class="payment-form-container">
                    <div class="section-title">üí≥ Form Pembayaran</div>
                    
                    <div class="selected-invoice">
                        <h4>üìÑ ${selectedInvoice.number}</h4>
                        <p>üè™ ${selectedInvoice.toko}</p>
                        ${paymentInfo}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmount" class="form-input" placeholder="Masukkan jumlah pembayaran" value="${selectedInvoice.remainingAmount}" onkeyup="validatePaymentAmount()">
                        <small id="paymentValidation" class="payment-validation"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jenis Pembayaran</label>
                        <div class="payment-type-section">
                            <button type="button" id="lunasBtn" class="payment-type-btn" onclick="setPaymentType('lunas')">‚úÖ Lunas</button>
                            <button type="button" id="titipBtn" class="payment-type-btn" onclick="setPaymentType('titip')">üì¶ Titip</button>
                        </div>
                        <input type="hidden" id="selectedPaymentType" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí≥ Metode Pembayaran</label>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'cash')">üíµ Cash</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'transfer')">üè¶ Transfer</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'cek')">üìÑ Cek</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'giro')">üìù Giro</div>
                            <div class="payment-method" onclick="selectPaymentMethod(this, 'qris')">üì± QRIS</div>
                        </div>
                        <input type="hidden" id="selectedPaymentMethod" value="">
                    </div>
                    
                    <div class="form-group" id="proofUploadSection" style="display: none;">
                        <label class="form-label">üì∑ Upload Bukti Pembayaran</label>
                        <input type="file" id="paymentProof" class="form-input" accept="image/*">
                        <small>Klik untuk upload foto bukti transfer/cek/giro</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üìù Catatan (Opsional)</label>
                        <textarea id="paymentNotes" class="form-input" placeholder="Catatan tambahan..." rows="3"></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="processPayment()" class="btn btn-success">üí≥ Proses Pembayaran</button>
                        <button onclick="showTagihan()" class="btn btn-secondary">‚ùå Batal</button>
                    </div>
                </div>
            `;
            
            showContent(content);
            
            // Set default payment type to lunas
            setPaymentType('lunas');
        }
        
        // Process single payment
        function processPayment() {
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentType = document.getElementById('selectedPaymentType').value;
            const paymentMethod = document.getElementById('selectedPaymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            const paymentProof = document.getElementById('paymentProof');
            
            console.log('Processing payment:', {paymentAmount, paymentType, paymentMethod});
            
            // Validation
            if (!paymentAmount || paymentAmount <= 0) {
                alert('‚ùå Masukkan jumlah pembayaran yang valid!');
                return;
            }
            
            // Check previous payments and remaining amount
            const totalPaid = getTotalPaidForInvoice(selectedInvoice.number);
            const originalAmount = selectedInvoice.amount;
            const remainingAmount = originalAmount - totalPaid;
            
            // Validate payment amount tidak boleh lebih dari sisa tagihan
            if (paymentAmount > remainingAmount) {
                alert(`‚ùå PEMBAYARAN MELEBIHI SISA TAGIHAN!\n\n` +
                      `üí∞ Total Faktur: Rp ${originalAmount.toLocaleString('id-ID')}\n` +
                      `üìä Sudah Dibayar: Rp ${totalPaid.toLocaleString('id-ID')}\n` +
                      `‚ö†Ô∏è Sisa Tagihan: Rp ${remainingAmount.toLocaleString('id-ID')}\n\n` +
                      `üö´ Anda mencoba bayar: Rp ${paymentAmount.toLocaleString('id-ID')}\n\n` +
                      `Silakan masukkan jumlah maksimal Rp ${remainingAmount.toLocaleString('id-ID')}`);
                return;
            }
            
            if (!paymentType) {
                alert('‚ùå Pilih jenis pembayaran (Lunas/Titip)!');
                return;
            }
            
            if (!paymentMethod) {
                alert('‚ùå Pilih metode pembayaran!');
                return;
            }
            
            // History rules: Transfer/Cek/Giro WAJIB upload bukti
            const needsProof = (paymentMethod === 'transfer' || paymentMethod === 'cek' || paymentMethod === 'giro');
            
            if (needsProof && (!paymentProof.files || paymentProof.files.length === 0)) {
                alert('‚ùå Upload bukti pembayaran untuk metode ini!');
                return;
            }
            
            // Get method display name
            const methodNames = {
                'cash': 'üíµ Cash',
                'transfer': 'üè¶ Transfer',
                'cek': 'üìÑ Cek', 
                'giro': 'üìù Giro',
                'qris': 'üì± QRIS'
            };
            
            // Process payment based on history rules
            const paymentData = {
                invoice: selectedInvoice.number,
                toko: selectedInvoice.toko,
                amount: paymentAmount,
                invoiceAmount: selectedInvoice.amount,
                type: paymentType,
                method: methodNames[paymentMethod] || paymentMethod,
                notes: paymentNotes,
                proof: paymentProof.files?.[0]?.name || '',
                timestamp: new Date().toLocaleString('id-ID')
            };
            
            // Determine payment status based on history logic
            let statusMessage = '';
            let detailMessage = '';
            
            // Use the totalPaid and originalAmount already declared above
            const remainingBeforePayment = remainingAmount;
            
            if (paymentType === 'lunas') {
                // LUNAS = Langsung disetor ke perusahaan
                detailMessage = 'üíº Status: Disetor langsung ke perusahaan';
                
                // Record this payment
                const paymentInfo = addInvoicePayment(selectedInvoice.number, paymentAmount, originalAmount);
                const newTotalPaid = paymentInfo.totalPaid;
                const newRemaining = originalAmount - newTotalPaid;
                
                if (newTotalPaid >= originalAmount) {
                    statusMessage = '‚úÖ PEMBAYARAN LUNAS PENUH';
                    if (totalPaid > 0) {
                        detailMessage += `\nüìä Riwayat: Sudah dibayar Rp ${totalPaid.toLocaleString('id-ID')} sebelumnya`;
                        detailMessage += `\nüí∞ Cicilan ini: Rp ${paymentAmount.toLocaleString('id-ID')}`;
                        detailMessage += `\n‚úÖ Total Terbayar: Rp ${newTotalPaid.toLocaleString('id-ID')}`;
                    }
                } else {
                    statusMessage = 'üì¶ PEMBAYARAN CICILAN';
                    detailMessage += `\nüí∞ Total Faktur: Rp ${originalAmount.toLocaleString('id-ID')}`;
                    if (totalPaid > 0) {
                        detailMessage += `\nüìä Sudah dibayar: Rp ${totalPaid.toLocaleString('id-ID')}`;
                    }
                    detailMessage += `\nüíµ Cicilan ini: Rp ${paymentAmount.toLocaleString('id-ID')}`;
                    detailMessage += `\n‚úÖ Total Terbayar: Rp ${newTotalPaid.toLocaleString('id-ID')}`;
                    detailMessage += `\n‚ö†Ô∏è Sisa tagihan: Rp ${newRemaining.toLocaleString('id-ID')}`;
                }
            } else {
                // TITIP = Dititip ke sales dulu
                statusMessage = 'üì¶ PEMBAYARAN DITITIP';
                detailMessage = 'üë§ Status: Dititip ke sales, belum disetor ke kantor';
                
                // Record this payment for titip as well
                const paymentInfo = addInvoicePayment(selectedInvoice.number, paymentAmount, originalAmount);
                const newTotalPaid = paymentInfo.totalPaid;
                const newRemaining = originalAmount - newTotalPaid;
                
                if (newRemaining > 0) {
                    detailMessage += `\nüí∞ Sisa tagihan: Rp ${newRemaining.toLocaleString('id-ID')}`;
                }
            }
            
            // Action message based on method (history rules)
            let actionMessage = '';
            switch(paymentMethod) {
                case 'cash':
                    actionMessage = 'üíµ CASH - Uang Dibawa Salesman\n‚ö†Ô∏è Uang saat ini masih dibawa oleh salesman\nüì± Customer akan dapat konfirmasi setelah uang disetor ke rekening perusahaan';
                    break;
                case 'transfer':
                    actionMessage = 'üè¶ Tindakan: Verifikasi transfer masuk ke rekening perusahaan\nüì± Customer akan dapat notifikasi WhatsApp setelah dana masuk rekening';
                    break;
                case 'cek':
                    actionMessage = 'üìÑ Tindakan: Cek akan diproses ke bank dalam 1-3 hari kerja\nüì± Customer akan dapat konfirmasi setelah cek cair';
                    break;
                case 'giro':
                    actionMessage = 'üìù Tindakan: Giro akan dicairkan sesuai tanggal jatuh tempo\nüì± Customer akan dapat konfirmasi setelah giro cair';
                    break;
                case 'qris':
                    actionMessage = 'üì± Tindakan: Pembayaran digital langsung masuk rekening\n‚úÖ Konfirmasi otomatis setelah pembayaran berhasil';
                    break;
            }
            
            // Success message
            const successMessage = `
                ${statusMessage}
                
                üìÑ Faktur: ${paymentData.invoice}
                üè™ Toko: ${paymentData.toko}
                üí∞ Jumlah Bayar: Rp ${paymentAmount.toLocaleString('id-ID')}
                üí∞ Total Tagihan: Rp ${selectedInvoice.amount.toLocaleString('id-ID')}
                üí≥ Metode: ${paymentData.method}
                ${detailMessage}
                ${actionMessage}
                üìù Catatan: ${paymentData.notes || 'Tidak ada'}
                ${paymentData.proof ? `üì∑ Bukti: ${paymentData.proof}` : ''}
                ‚è∞ Waktu: ${paymentData.timestamp}
            `;
            
            alert(successMessage);
            
            // Check if invoice is fully paid (including previous payments)
            const finalTotalPaid = getTotalPaidForInvoice(selectedInvoice.number);
            const isFullyPaid = finalTotalPaid >= selectedInvoice.amount;
            const invoiceToHide = isFullyPaid ? selectedInvoice.number : null;
            
            // Save to localStorage if payment is fully settled (lunas penuh)
            if (invoiceToHide) {
                addPaidInvoice(invoiceToHide);
                console.log('Invoice fully paid, added to paid list:', invoiceToHide);
            }
            
            // Redirect back to tagihan first, then update the invoice display
            setTimeout(() => {
                showTagihan();
                
                // If fully paid, hide invoice from list
                if (invoiceToHide) {
                    setTimeout(() => {
                        hideInvoiceFromList(invoiceToHide);
                    }, 300);
                } else {
                    // If partially paid, update the invoice amount display
                    setTimeout(() => {
                        updateInvoiceAmountDisplay(selectedInvoice.number, selectedInvoice.amount);
                    }, 300);
                }
            }, 500);
        }

        // Show batch payment form
        function showBatchPaymentForm() {
            document.getElementById('paymentForm').style.display = 'block';
            
            let summary = '<div class="batch-summary"><h4>üìã Faktur Dipilih:</h4>';
            let totalAmount = 0;
            
            selectedInvoices.forEach(inv => {
                summary += `<div class="batch-item">‚Ä¢ ${inv.toko} - ${inv.invoice}: Rp ${inv.amount.toLocaleString('id-ID')}</div>`;
                totalAmount += inv.amount;
            });
            
            summary += `<hr><strong>Total Semua Faktur: Rp ${totalAmount.toLocaleString('id-ID')}</strong></div>`;
            
            document.getElementById('selectedBill').innerHTML = summary;
            
            // Reset form
            document.getElementById('paymentAmount').value = '';
            document.getElementById('selectedPaymentType').value = '';
            document.querySelectorAll('.payment-type-btn').forEach(btn => {
                btn.classList.remove('active', 'disabled');
            });
            document.getElementById('paymentValidation').innerHTML = '';
        }
        
        // Validate payment amount and auto-select payment type
        function validatePaymentAmount() {
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const validationEl = document.getElementById('paymentValidation');
            const lunasBtn = document.getElementById('lunasBtn');
            const titipBtn = document.getElementById('titipBtn');
            
            // Reset buttons
            lunasBtn.classList.remove('active', 'disabled');
            titipBtn.classList.remove('active', 'disabled');
            document.getElementById('selectedPaymentType').value = '';
            
            if (paymentAmount <= 0) {
                validationEl.innerHTML = '';
                return;
            }
            
            // Auto-detect payment mode
            const currentPaymentMode = getPaymentMode();
            
            if (currentPaymentMode === 'batch') {
                // Batch payment validation
                validateBatchPayment(paymentAmount);
            } else {
                // Single payment validation
                if (paymentAmount >= currentInvoiceAmount) {
                    validationEl.innerHTML = '‚úÖ Pembayaran cukup untuk LUNAS';
                    validationEl.className = 'payment-validation valid';
                    
                    lunasBtn.classList.add('active');
                    titipBtn.classList.add('disabled');
                    document.getElementById('selectedPaymentType').value = 'lunas';
                    
                } else {
                    validationEl.innerHTML = '‚ö†Ô∏è Pembayaran kurang, otomatis TITIP';
                    validationEl.className = 'payment-validation invalid';
                    
                    titipBtn.classList.add('active');
                    lunasBtn.classList.add('disabled');
                    document.getElementById('selectedPaymentType').value = 'titip';
                }
            }
        }

        // Validate batch payment and calculate allocation
        function validateBatchPayment(paymentAmount) {
            const validationEl = document.getElementById('paymentValidation');
            
            // Sort selected invoices by date (oldest first)
            const sortedInvoices = [...selectedInvoices].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB; // Ascending order (oldest first)
            });
            
            let remainingPayment = paymentAmount;
            let allocations = [];
            let lunasCount = 0;
            let titipCount = 0;
            
            // Calculate allocation
            for (let invoice of sortedInvoices) {
                if (remainingPayment >= invoice.amount) {
                    // Can pay in full
                    allocations.push({
                        ...invoice,
                        paidAmount: invoice.amount,
                        status: 'lunas',
                        remaining: 0
                    });
                    remainingPayment -= invoice.amount;
                    lunasCount++;
                } else if (remainingPayment > 0) {
                    // Partial payment
                    allocations.push({
                        ...invoice,
                        paidAmount: remainingPayment,
                        status: 'titip',
                        remaining: invoice.amount - remainingPayment
                    });
                    remainingPayment = 0;
                    titipCount++;
                } else {
                    // No payment left
                    allocations.push({
                        ...invoice,
                        paidAmount: 0,
                        status: 'belum_bayar',
                        remaining: invoice.amount
                    });
                }
            }
            
            // Display allocation result
            let resultHtml = '<div class="batch-allocation"><h4>üí∞ Alokasi Pembayaran (Urutan: Terlama ‚Üí Terbaru):</h4>';
            
            allocations.forEach(alloc => {
                let statusIcon = alloc.status === 'lunas' ? '‚úÖ' : alloc.status === 'titip' ? '‚ö†Ô∏è' : '‚ùå';
                let statusText = alloc.status === 'lunas' ? 'LUNAS' : alloc.status === 'titip' ? 'TITIP' : 'BELUM BAYAR';
                
                // Format date for display
                const invoiceDate = new Date(alloc.date);
                const formattedDate = invoiceDate.toLocaleDateString('id-ID');
                
                resultHtml += `<div class="allocation-item ${alloc.status}">
                    ${statusIcon} ${alloc.toko} - ${alloc.invoice} (üìÖ ${formattedDate})<br>
                    Bayar: Rp ${alloc.paidAmount.toLocaleString('id-ID')} / ${alloc.amount.toLocaleString('id-ID')} ‚Üí ${statusText}`;
                
                if (alloc.remaining > 0) {
                    resultHtml += `<br>Sisa: Rp ${alloc.remaining.toLocaleString('id-ID')}`;
                }
                
                resultHtml += '</div>';
            });
            
            resultHtml += `<hr><strong>Summary: ${lunasCount} Lunas, ${titipCount} Titip</strong><br><small>üí° Prioritas pembayaran berdasarkan faktur terlama</small></div>`;
            
            validationEl.innerHTML = resultHtml;
            validationEl.className = 'payment-validation batch-valid';
            
            // Store allocation for processing
            window.currentBatchAllocation = allocations;
            
            // Enable batch payment button
            document.getElementById('selectedPaymentType').value = 'batch';
        }
        
        // Set payment type (manual selection)
        function setPaymentType(type) {
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            
            if (paymentAmount <= 0) {
                alert('‚ùå Masukkan jumlah pembayaran terlebih dahulu!');
                return;
            }
            
            // Get invoice amount from selectedInvoice
            const invoiceAmount = selectedInvoice ? selectedInvoice.amount : 0;
            
            // Validate if lunas is possible
            if (type === 'lunas' && paymentAmount < invoiceAmount) {
                alert(`‚ùå Tidak bisa LUNAS!\nPembayaran: Rp ${paymentAmount.toLocaleString('id-ID')}\nTotal Faktur: Rp ${invoiceAmount.toLocaleString('id-ID')}\n\nGunakan TITIP untuk pembayaran sebagian.`);
                return;
            }
            
            // Update buttons - make them visually active
            document.querySelectorAll('.payment-type-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = '';
                btn.style.color = '';
            });
            
            const selectedBtn = document.getElementById(type + 'Btn');
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.backgroundColor = '#667eea';
                selectedBtn.style.color = 'white';
            }
            
            document.getElementById('selectedPaymentType').value = type;
            
            console.log('Payment type set to:', type);
        }

        // Select Payment Method
        function selectPaymentMethod(element, method) {
            // Remove previous selection
            document.querySelectorAll('.payment-method').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current method
            element.classList.add('selected');
            
            // Set hidden input value
            document.getElementById('selectedPaymentMethod').value = method;
            
            // Show file upload for transfer/cek/giro based on history rules
            const proofUploadSection = document.getElementById('proofUploadSection');
            if (method === 'transfer' || method === 'cek' || method === 'giro') {
                if (proofUploadSection) {
                    proofUploadSection.style.display = 'block';
                }
            } else {
                if (proofUploadSection) {
                    proofUploadSection.style.display = 'none';
                }
            }
            
            console.log('Payment method selected:', method);
        }

        // Hide Payment Form
        function hidePaymentForm() {
            document.getElementById('paymentForm').style.display = 'none';
            document.querySelectorAll('.tagihan-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Submit Payment
        function submitPayment() {
            const paymentType = document.getElementById('selectedPaymentType').value;
            const paymentMethod = document.querySelector('.payment-method.selected');
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            
            if (!paymentType || !paymentMethod || paymentAmount <= 0) {
                alert('‚ùå Lengkapi semua field pembayaran!');
                return;
            }
            
            // Auto-detect payment mode
            const currentPaymentMode = getPaymentMode();
            
            // Handle batch payment
            if (currentPaymentMode === 'batch') {
                if (selectedInvoices.length === 0) {
                    alert('‚ùå Pilih minimal 1 faktur untuk batch payment!');
                    return;
                }
                
                // Ensure batch allocation is calculated
                validateBatchPayment(paymentAmount);
                
                setTimeout(() => {
                    processBatchPayment(paymentAmount, paymentMethod);
                }, 100);
                return;
            }
            
            // Final validation for lunas/titip logic
            if (paymentType === 'lunas' && paymentAmount < currentInvoiceAmount) {
                alert(`‚ùå Error: Tidak bisa LUNAS!\nPembayaran: Rp ${paymentAmount.toLocaleString('id-ID')}\nTotal Faktur: Rp ${currentInvoiceAmount.toLocaleString('id-ID')}\nOtomatis diubah ke TITIP.`);
                
                // Auto change to titip
                document.getElementById('selectedPaymentType').value = 'titip';
                document.querySelectorAll('.payment-type-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('titipBtn').classList.add('active');
                return;
            }
            
            const methodText = paymentMethod.textContent;
            const needsProof = methodText.includes('Transfer') || methodText.includes('Cek') || methodText.includes('Giro');
            const proofFile = document.getElementById('paymentProof').files[0];
            
            if (needsProof && !proofFile) {
                alert('‚ùå Upload bukti pembayaran untuk metode ini!');
                return;
            }
            
            // Simulate payment processing
            alert('‚è≥ Memproses pembayaran...');
            
            setTimeout(() => {
                let message = `‚úÖ Pembayaran Berhasil Diproses!\n\n`;
                message += `ÔøΩ Faktur: ${currentInvoiceNo}\n`;
                message += `üí∞ Total Faktur: Rp ${currentInvoiceAmount.toLocaleString('id-ID')}\n`;
                message += `üí≥ Jumlah Bayar: Rp ${paymentAmount.toLocaleString('id-ID')}\n`;
                message += `üìã Status: ${paymentType === 'lunas' ? '‚úÖ LUNAS' : 'üì¶ TITIP'}\n`;
                message += `üí≥ Metode: ${methodText}\n\n`;
                
                if (paymentType === 'lunas') {
                    const change = paymentAmount - currentInvoiceAmount;
                    if (change > 0) {
                        message += `ÔøΩ Kembalian: Rp ${change.toLocaleString('id-ID')}\n`;
                    }
                    message += `üéâ Faktur telah LUNAS!\n`;
                } else {
                    const remaining = currentInvoiceAmount - paymentAmount;
                    message += `‚ö†Ô∏è Sisa Tagihan: Rp ${remaining.toLocaleString('id-ID')}\n`;
                    message += `üì¶ Status: TITIP (Pembayaran Sebagian)\n`;
                }
                
                if (methodText.includes('Transfer')) {
                    message += `\nüè¶ Status: Menunggu konfirmasi bank\n`;
                    message += `üì± Customer akan dapat notifikasi WhatsApp setelah dana masuk rekening`;
                } else if (methodText.includes('Cash')) {
                    message += `\nüíµ CASH - Uang Dibawa Salesman\n`;
                    message += `‚ö†Ô∏è Uang saat ini masih dibawa oleh salesman\n`;
                    message += `üì± Customer akan dapat konfirmasi setelah uang disetor ke rekening perusahaan`;
                } else {
                    message += `\nüìÑ Status: Menunggu pencairan\n`;
                    message += `üì± Customer akan dapat konfirmasi setelah cek/giro cair`;
                }
                
                alert(message);
                
                // Hide paid invoice from list if lunas
                if (paymentType === 'lunas') {
                    updateInvoiceStatus(currentInvoiceNo, 'lunas');
                    hideInvoiceFromList(currentInvoiceNo);
                }
                
                hidePaymentForm();
            }, 2000);
        }

        // Process Batch Payment
        function processBatchPayment(paymentAmount, paymentMethod) {
            const methodText = paymentMethod.textContent;
            const needsProof = methodText.includes('Transfer') || methodText.includes('Cek') || methodText.includes('Giro');
            const proofFile = document.getElementById('paymentProof').files[0];
            
            if (needsProof && !proofFile) {
                alert('‚ùå Upload bukti pembayaran untuk metode ini!');
                return;
            }
            
            if (!window.currentBatchAllocation) {
                alert('‚ùå Error: Data alokasi pembayaran tidak ditemukan!');
                return;
            }
            
            // Simulate batch payment processing
            alert('‚è≥ Memproses pembayaran multiple faktur...');
            
            setTimeout(() => {
                const allocations = window.currentBatchAllocation;
                let message = `‚úÖ Batch Payment Berhasil Diproses!\n\n`;
                message += `üí≥ Total Pembayaran: Rp ${paymentAmount.toLocaleString('id-ID')}\n`;
                message += `üí≥ Metode: ${methodText}\n\n`;
                message += `üìã Hasil Alokasi:\n`;
                
                let lunasCount = 0;
                let titipCount = 0;
                
                allocations.forEach(alloc => {
                    if (alloc.status === 'lunas') {
                        message += `‚úÖ ${alloc.toko} - ${alloc.invoice}: LUNAS (Rp ${alloc.paidAmount.toLocaleString('id-ID')})\n`;
                        lunasCount++;
                        
                        // Mark invoice as paid in UI
                        updateInvoiceStatus(alloc.invoice, 'lunas');
                        
                    } else if (alloc.status === 'titip') {
                        message += `‚ö†Ô∏è ${alloc.toko} - ${alloc.invoice}: TITIP (Bayar: Rp ${alloc.paidAmount.toLocaleString('id-ID')}, Sisa: Rp ${alloc.remaining.toLocaleString('id-ID')})\n`;
                        titipCount++;
                        
                        // Mark invoice as partial payment in UI
                        updateInvoiceStatus(alloc.invoice, 'titip');
                        
                    } else {
                        message += `‚ùå ${alloc.toko} - ${alloc.invoice}: BELUM BAYAR\n`;
                    }
                });
                
                message += `\nüìä Summary:\n`;
                message += `‚úÖ ${lunasCount} faktur LUNAS\n`;
                message += `‚ö†Ô∏è ${titipCount} faktur TITIP\n`;
                
                if (methodText.includes('Cash')) {
                    message += `\nüíµ CASH - Uang Dibawa Salesman\n`;
                    message += `‚ö†Ô∏è Total uang yang dibawa salesman: Rp ${paymentAmount.toLocaleString('id-ID')}\n`;
                }
                
                message += `\nüéâ Batch payment selesai!`;
                
                alert(message);
                
                // Hide all lunas invoices from list
                allocations.forEach(alloc => {
                    if (alloc.status === 'lunas') {
                        hideInvoiceFromList(alloc.invoice);
                    }
                });
                
                // Reset batch mode
                selectedInvoices = [];
                batchTotalAmount = 0;
                document.querySelectorAll('.invoice-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.tagihan-item').forEach(item => {
                    item.classList.remove('batch-selected');
                });
                
                hidePaymentForm();
                updateTagihanCounter();
                
            }, 3000);
        }

        // Update invoice status in UI
        function updateInvoiceStatus(invoiceNo, status) {
            const invoiceItems = document.querySelectorAll(`[data-invoice="${invoiceNo}"]`);
            invoiceItems.forEach(item => {
                const statusEl = item.querySelector('.tagihan-status');
                if (statusEl) {
                    if (status === 'lunas') {
                        statusEl.innerHTML = '‚úÖ LUNAS';
                        statusEl.className = 'tagihan-status status-lunas';
                        item.style.opacity = '0.7';
                    } else if (status === 'titip') {
                        statusEl.innerHTML = 'üì¶ TITIP';
                        statusEl.className = 'tagihan-status status-titip';
                    }
                }
            });
        }
        
        // Update invoice amount display after partial payment
        function updateInvoiceAmountDisplay(invoiceNo, originalAmount) {
            const invoiceItems = document.querySelectorAll(`[data-invoice="${invoiceNo}"]`);
            const remainingAmount = getInvoiceRemainingAmount(invoiceNo, originalAmount);
            const totalPaid = getTotalPaidForInvoice(invoiceNo);
            
            console.log(`Updating invoice ${invoiceNo}: Original Rp ${originalAmount.toLocaleString('id-ID')}, Paid Rp ${totalPaid.toLocaleString('id-ID')}, Remaining Rp ${remainingAmount.toLocaleString('id-ID')}`);
            
            invoiceItems.forEach(item => {
                // Update the amount display
                const amountEl = item.querySelector('.invoice-amount');
                if (amountEl) {
                    if (remainingAmount < originalAmount) {
                        // Show remaining amount with strikethrough original
                        amountEl.innerHTML = `üí∞ <span style="text-decoration: line-through; color: #999;">Rp ${originalAmount.toLocaleString('id-ID')}</span><br><span style="color: #f39c12; font-weight: bold;">Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}</span>`;
                    } else {
                        amountEl.innerHTML = `üí∞ Rp ${originalAmount.toLocaleString('id-ID')}`;
                    }
                }
                
                // Update data-amount attribute for calculations
                item.dataset.amount = remainingAmount;
                
                // Add visual indicator for partial payment
                if (totalPaid > 0 && remainingAmount > 0) {
                    item.style.borderLeft = '4px solid #f39c12';
                    const statusEl = item.querySelector('.tagihan-status');
                    if (statusEl && !statusEl.textContent.includes('CICILAN')) {
                        statusEl.innerHTML = 'üí∞ Cicilan';
                        statusEl.className = 'tagihan-status';
                        statusEl.style.background = '#f39c12';
                        statusEl.style.color = 'white';
                    }
                }
            });
            
            // Update toko group totals
            const tokoGroup = document.querySelector(`[data-invoice="${invoiceNo}"]`)?.closest('.toko-group');
            if (tokoGroup) {
                updateTokoGroupTotals(tokoGroup);
            }
        }
        
        // Update toko group totals after payment
        function updateTokoGroupTotals(tokoGroup) {
            const invoiceCountEl = tokoGroup.querySelector('.invoice-count');
            const totalAmountEl = tokoGroup.querySelector('.total-amount');
            const remainingInvoices = tokoGroup.querySelectorAll('.tagihan-item');
            
            let totalAmount = 0;
            remainingInvoices.forEach(invoice => {
                const amount = parseInt(invoice.dataset.amount) || 0;
                totalAmount += amount;
            });
            
            if (invoiceCountEl) {
                invoiceCountEl.textContent = `${remainingInvoices.length} faktur`;
            }
            
            if (totalAmountEl) {
                totalAmountEl.textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
            }
        }
        
        // Hide paid invoice from list
        function hideInvoiceFromList(invoiceNo) {
            console.log('Hiding invoice:', invoiceNo);
            const invoiceItems = document.querySelectorAll(`[data-invoice="${invoiceNo}"]`);
            console.log('Found items to hide:', invoiceItems.length);
            
            invoiceItems.forEach(item => {
                // Get the parent toko group before removing
                const tokoGroup = item.closest('.toko-group');
                const invoiceAmount = parseInt(item.dataset.amount) || 0;
                
                // Hide the invoice with smooth fade out
                item.style.transition = 'opacity 0.5s, height 0.5s';
                item.style.opacity = '0';
                item.style.height = '0';
                item.style.overflow = 'hidden';
                item.style.marginBottom = '0';
                item.style.padding = '0';
                
                // Remove from DOM after animation
                setTimeout(() => {
                    // Actually remove from DOM
                    item.remove();
                    
                    console.log('Invoice removed:', invoiceNo);
                    
                    // Update toko group header
                    if (tokoGroup) {
                        const remainingInvoices = tokoGroup.querySelectorAll('.tagihan-item');
                        const invoiceCountEl = tokoGroup.querySelector('.invoice-count');
                        const totalAmountEl = tokoGroup.querySelector('.total-amount');
                        
                        if (remainingInvoices.length === 0) {
                            // Jika tidak ada invoice tersisa, sembunyikan toko
                            tokoGroup.style.display = 'none';
                            console.log('Toko group hidden - no more invoices');
                        } else {
                            // Update jumlah nota
                            const count = remainingInvoices.length;
                            if (invoiceCountEl) {
                                invoiceCountEl.textContent = `${count} faktur`;
                            }
                            
                            // Update total nominal
                            let totalAmount = 0;
                            remainingInvoices.forEach(inv => {
                                const amount = parseInt(inv.dataset.amount) || 0;
                                totalAmount += amount;
                            });
                            
                            if (totalAmountEl) {
                                totalAmountEl.textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
                            }
                            
                            console.log(`Updated toko header: ${count} invoices, total: Rp ${totalAmount.toLocaleString('id-ID')}`);
                        }
                    }
                    
                    // Update counter
                    updateTagihanCounter();
                    updateTokoSelectorCounts(); // Update dropdown counts
                }, 600);
            });
        }

        // Show Orderan (Kunjungan)
        function showOrderan() {
            if (!callPlanCreated) {
                alert('‚ùå Buat Call Plan terlebih dahulu!');
                return;
            }
            
            const content = `
                <div class="section-title">üì¶ Orderan Kunjungan</div>
                
                <div class="alert alert-success">
                    ‚ÑπÔ∏è Orderan dari kunjungan langsung ke toko
                </div>
                
                <!-- Validasi Toko Baru -->
                <div class="new-store-validation" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #495057; margin-bottom: 15px;">üè™ Validasi Toko Baru</h4>
                    <div class="validation-steps">
                        <button onclick="scanBarcode()" class="btn btn-outline-primary" style="margin: 5px;">üì± Scan Barcode Toko</button>
                        <button onclick="validateGPS()" class="btn btn-outline-success" style="margin: 5px;">üìç Validasi GPS</button>
                        <button onclick="takeSelfie()" class="btn btn-outline-warning" style="margin: 5px;">ü§≥ Ambil Selfie</button>
                    </div>
                    <div id="validationStatus" style="margin-top: 10px; font-size: 14px;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üè™ Pilih Customer</label>
                    <select class="form-select" id="customerSelect" onchange="loadCustomerInfo()">
                        <option value="">-- Pilih Customer --</option>
                        <option value="Toko Sari Rasa">üè™ Toko Sari Rasa</option>
                        <option value="Warung Maju Jaya">üè™ Warung Maju Jaya</option>
                        <option value="Toko Berkah">üè™ Toko Berkah</option>
                        <option value="Minimarket Sejahtera">üè™ Minimarket Sejahtera</option>
                    </select>
                </div>
                
                <div id="customerInfo" class="customer-info hidden">
                    <div class="info-card">
                        <h4>üìã Info Customer</h4>
                        <div id="customerDetails"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üè∑Ô∏è Jenis Barang</label>
                    <div class="category-buttons">
                        <button onclick="selectCategory('makanan')" class="category-btn" id="cat-makanan">üçú Makanan</button>
                        <button onclick="selectCategory('minuman')" class="category-btn" id="cat-minuman">ü•§ Minuman</button>
                        <button onclick="selectCategory('sembako')" class="category-btn" id="cat-sembako">ÔøΩ Sembako</button>
                        <button onclick="selectCategory('snack')" class="category-btn" id="cat-snack">üç™ Snack</button>
                        <button onclick="selectCategory('bumbu')" class="category-btn" id="cat-bumbu">üßÑ Bumbu</button>
                        <button onclick="selectCategory('lainnya')" class="category-btn" id="cat-lainnya">ÔøΩ Lainnya</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üì¶ Pilih Produk</label>
                    <select class="form-select" id="productSelect" onchange="updateProductPrice()">
                        <option value="">-- Pilih jenis barang terlebih dahulu --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìä Jumlah</label>
                    <input type="number" id="quantityInput" class="form-input" placeholder="Masukkan jumlah" min="1" onchange="calculateSubtotal()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Harga Satuan</label>
                    <input type="number" id="priceInput" class="form-input" placeholder="Harga akan otomatis terisi" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üíµ Subtotal</label>
                    <input type="text" id="subtotalDisplay" class="form-input" placeholder="Subtotal akan dihitung otomatis" readonly>
                </div>
                
                <button onclick="addOrderItem('kunjungan')" class="btn btn-primary">‚ûï Tambah Item</button>
                
                <div id="orderList" class="order-list">
                    <h4>üõí Daftar Order</h4>
                    <div id="orderItems"></div>
                    <div id="orderTotal"></div>
                </div>
                
                <div class="order-actions">
                    <button onclick="submitOrder('kunjungan')" class="btn btn-success">üöÄ Submit Order</button>
                    <button onclick="clearOrder()" class="btn btn-secondary">üóëÔ∏è Clear All</button>
                </div>
                
                <style>
                .customer-info {
                    margin: 15px 0;
                }
                
                .info-card {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    border-left: 4px solid #28a745;
                }
                
                .info-card h4 {
                    margin: 0 0 10px 0;
                    color: #333;
                }
                
                .category-buttons {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                    margin-top: 5px;
                }
                
                .category-btn {
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 12px;
                    text-align: center;
                }
                
                .category-btn:hover {
                    border-color: #667eea;
                    background: #f8f9ff;
                }
                
                .category-btn.active {
                    background: #667eea;
                    color: white;
                    border-color: #667eea;
                }
                
                .order-actions {
                    display: grid;
                    grid-template-columns: 2fr 1fr;
                    gap: 10px;
                    margin-top: 20px;
                }
                
                .order-list {
                    margin: 20px 0;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    min-height: 100px;
                }
                
                .order-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    background: white;
                    border-radius: 6px;
                    margin-bottom: 8px;
                    border-left: 4px solid #28a745;
                }
                
                .order-item-info {
                    flex: 1;
                }
                
                .order-item-actions {
                    display: flex;
                    gap: 5px;
                }
                
                .remove-btn {
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 5px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                }
                
                .edit-btn {
                    background: #ffc107;
                    color: #333;
                    border: none;
                    padding: 5px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                }
                </style>
            `;
            
            showContent(content);
            setupOrderHandlers();
        }

        // Show Order Telpon
        function showOrderTelpon() {
            if (!callPlanCreated) {
                alert('‚ùå Buat Call Plan terlebih dahulu!');
                return;
            }
            
            const content = `
                <div class="section-title">üìû Order via Telepon</div>
                
                <div class="alert alert-success">
                    ‚ÑπÔ∏è Orderan yang masuk via telepon dengan format sama seperti kunjungan
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìû Nomor Telepon Customer</label>
                    <input type="tel" id="customerPhone" class="form-input" placeholder="08xxxxxxxxxx">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üè™ Nama Customer/Toko</label>
                    <input type="text" id="customerName" class="form-input" placeholder="Nama toko/customer">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üì¶ Pilih Produk</label>
                    <select class="form-select" id="productSelectTelpon">
                        <option value="">-- Pilih Produk --</option>
                        <option value="Indomie Goreng" data-price="3500">üçú Indomie Goreng - Rp 3.500</option>
                        <option value="Teh Botol Sosro" data-price="4000">üßä Teh Botol Sosro - Rp 4.000</option>
                        <option value="Aqua 600ml" data-price="3000">üíß Aqua 600ml - Rp 3.000</option>
                        <option value="Beras Premium" data-price="75000">üåæ Beras Premium - Rp 75.000</option>
                        <option value="Minyak Goreng" data-price="25000">üõ¢Ô∏è Minyak Goreng - Rp 25.000</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìä Jumlah</label>
                    <input type="number" id="quantityInputTelpon" class="form-input" placeholder="Masukkan jumlah" min="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Harga Satuan</label>
                    <input type="number" id="priceInputTelpon" class="form-input" placeholder="Harga akan otomatis terisi">
                </div>
                
                <button onclick="addOrderItem('telpon')" class="btn btn-primary">‚ûï Tambah Item</button>
                
                <div id="orderListTelpon" class="order-list">
                    <h4>üõí Daftar Order Telepon</h4>
                    <div id="orderItemsTelpon"></div>
                    <div id="orderTotalTelpon"></div>
                </div>
                
                <button onclick="submitOrder('telpon')" class="btn btn-success">üöÄ Submit Order Telepon</button>
            `;
            
            showContent(content);
            setupOrderHandlers();
        }

        // Product data by category
        const productData = {
            makanan: [
                {name: 'Indomie Goreng', price: 3500, icon: 'üçú'},
                {name: 'Indomie Soto', price: 3500, icon: 'üçú'},
                {name: 'Sarimi Ayam Bawang', price: 3000, icon: 'üçú'},
                {name: 'Pop Mie Rasa Ayam', price: 5000, icon: 'üçú'},
                {name: 'Mie Sedaap Goreng', price: 3200, icon: 'üçú'}
            ],
            minuman: [
                {name: 'Teh Botol Sosro', price: 4000, icon: 'üßä'},
                {name: 'Aqua 600ml', price: 3000, icon: 'üíß'},
                {name: 'Coca Cola 330ml', price: 5000, icon: 'ü•§'},
                {name: 'Sprite 330ml', price: 5000, icon: 'ü•§'},
                {name: 'Fanta Orange', price: 5000, icon: 'üßÉ'},
                {name: 'Teh Pucuk', price: 4500, icon: 'üçÉ'}
            ],
            sembako: [
                {name: 'Beras Premium 5kg', price: 75000, icon: 'üåæ'},
                {name: 'Minyak Goreng 2L', price: 25000, icon: 'üõ¢Ô∏è'},
                {name: 'Gula Pasir 1kg', price: 15000, icon: 'üßÇ'},
                {name: 'Tepung Terigu 1kg', price: 12000, icon: 'üåæ'},
                {name: 'Garam Dapur 500g', price: 3000, icon: 'üßÇ'}
            ],
            snack: [
                {name: 'Chitato Rasa BBQ', price: 8000, icon: 'üç™'},
                {name: 'Taro Coklat', price: 7000, icon: 'üç™'},
                {name: 'Oreo Original', price: 12000, icon: 'üç™'},
                {name: 'Pocky Chocolate', price: 15000, icon: 'üç´'},
                {name: 'Pringles Original', price: 25000, icon: 'ü•î'}
            ],
            bumbu: [
                {name: 'Royco Ayam', price: 8000, icon: 'üßÑ'},
                {name: 'Masako Sapi', price: 8500, icon: 'üßÑ'},
                {name: 'Kecap Manis ABC', price: 12000, icon: 'ü•´'},
                {name: 'Saos Sambal ABC', price: 10000, icon: 'üå∂Ô∏è'},
                {name: 'Bumbu Rendang', price: 15000, icon: 'üßÑ'}
            ],
            lainnya: [
                {name: 'Sabun Mandi Lifebuoy', price: 8000, icon: 'üßº'},
                {name: 'Shampo Pantene', price: 25000, icon: 'üß¥'},
                {name: 'Pasta Gigi Pepsodent', price: 12000, icon: 'ü¶∑'},
                {name: 'Deterjen Rinso', price: 18000, icon: 'üßΩ'},
                {name: 'Tissue Nice', price: 15000, icon: 'üßª'}
            ]
        };
        
        // Order management
        let orderItems = [];
        let orderCounter = 1;
        let selectedCategory = '';
        
        // Load customer info
        function loadCustomerInfo() {
            const customerSelect = document.getElementById('customerSelect');
            const customerInfo = document.getElementById('customerInfo');
            const customerDetails = document.getElementById('customerDetails');
            
            if (customerSelect.value) {
                const customers = {
                    'Toko Sari Rasa': {
                        address: 'Jl. Merdeka No. 123, Jakarta Pusat',
                        phone: '021-1234567',
                        contact: 'Pak Budi',
                        lastOrder: '2025-09-05'
                    },
                    'Warung Maju Jaya': {
                        address: 'Jl. Sudirman No. 456, Jakarta Selatan', 
                        phone: '021-7654321',
                        contact: 'Bu Siti',
                        lastOrder: '2025-09-08'
                    },
                    'Toko Berkah': {
                        address: 'Jl. Thamrin No. 789, Jakarta Barat',
                        phone: '021-9876543', 
                        contact: 'Pak Ahmad',
                        lastOrder: '2025-09-07'
                    },
                    'Minimarket Sejahtera': {
                        address: 'Jl. Gatot Subroto No. 321, Jakarta Timur',
                        phone: '021-5678901',
                        contact: 'Bu Linda', 
                        lastOrder: '2025-09-09'
                    }
                };
                
                const customer = customers[customerSelect.value];
                if (customer) {
                    customerDetails.innerHTML = `
                        <p><strong>üìç Alamat:</strong> ${customer.address}</p>
                        <p><strong>üìû Telepon:</strong> ${customer.phone}</p>
                        <p><strong>üë§ Kontak:</strong> ${customer.contact}</p>
                        <p><strong>üìÖ Order Terakhir:</strong> ${customer.lastOrder}</p>
                    `;
                    customerInfo.classList.remove('hidden');
                }
            } else {
                customerInfo.classList.add('hidden');
            }
        }
        
        // Select category and load products
        function selectCategory(category) {
            selectedCategory = category;
            
            // Update category button states
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('cat-' + category).classList.add('active');
            
            // Load products for selected category
            const productSelect = document.getElementById('productSelect');
            productSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
            
            if (productData[category]) {
                productData[category].forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.setAttribute('data-price', product.price);
                    option.textContent = `${product.icon} ${product.name} - Rp ${product.price.toLocaleString('id-ID')}`;
                    productSelect.appendChild(option);
                });
            }
        }
        
        // Update product price when selected
        function updateProductPrice() {
            const productSelect = document.getElementById('productSelect');
            const priceInput = document.getElementById('priceInput');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            if (selectedOption && selectedOption.getAttribute('data-price')) {
                priceInput.value = selectedOption.getAttribute('data-price');
                calculateSubtotal();
            } else {
                priceInput.value = '';
                document.getElementById('subtotalDisplay').value = '';
            }
        }
        
        // Calculate subtotal
        function calculateSubtotal() {
            const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
            const price = parseInt(document.getElementById('priceInput').value) || 0;
            const subtotal = quantity * price;
            
            document.getElementById('subtotalDisplay').value = subtotal > 0 ? `Rp ${subtotal.toLocaleString('id-ID')}` : '';
        }
        
        // Clear order
        function clearOrder() {
            if (orderItems.length === 0) {
                alert('‚ÑπÔ∏è Tidak ada order untuk dihapus');
                return;
            }
            
            if (confirm('‚ö†Ô∏è Yakin ingin menghapus semua order?')) {
                orderItems = [];
                updateOrderDisplay('kunjungan');
                alert('‚úÖ Semua order berhasil dihapus');
            }
        }

        // Initialize auto-fill price functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-fill price when product is selected
            const productSelects = document.querySelectorAll('#productSelect, #productSelectTelpon');
            productSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const price = selectedOption.getAttribute('data-price');
                    const priceInput = this.id === 'productSelect' ? 
                        document.getElementById('priceInput') : 
                        document.getElementById('priceInputTelpon');
                    
                    if (price && priceInput) {
                        priceInput.value = price;
                    }
                });
            });
        });

        // Add Order Item
        function addOrderItem(type) {
            const suffix = type === 'telpon' ? 'Telpon' : '';
            const customerSelect = document.getElementById('customerSelect' + suffix);
            const productSelect = document.getElementById(`productSelect${suffix}`);
            const quantityInput = document.getElementById(`quantityInput${suffix}`);
            const priceInput = document.getElementById(`priceInput${suffix}`);
            
            const customer = customerSelect ? customerSelect.value : '';
            const product = productSelect.value;
            const quantity = parseInt(quantityInput.value);
            const price = parseInt(priceInput.value);
            
            if (!customer && type === 'kunjungan') {
                alert('‚ùå Pilih customer terlebih dahulu!');
                return;
            }
            
            if (!selectedCategory && type === 'kunjungan') {
                alert('‚ùå Pilih jenis barang terlebih dahulu!');
                return;
            }
            
            if (!product || !quantity || !price) {
                alert('‚ùå Lengkapi semua field produk!');
                return;
            }
            
            const item = {
                id: Date.now(),
                customer: customer,
                category: selectedCategory,
                product: product,
                quantity: quantity,
                price: price,
                total: quantity * price,
                type: type
            };
            
            orderItems.push(item);
            updateOrderDisplay(type);
            
            // Clear inputs
            productSelect.value = '';
            quantityInput.value = '';
            priceInput.value = '';
            if (type === 'kunjungan') {
                document.getElementById('subtotalDisplay').value = '';
            }
            
            alert(`‚úÖ Item "${product}" berhasil ditambahkan!`);
        }
        
        // Update order display
        function updateOrderDisplay(type) {
            const orderItemsEl = document.getElementById('orderItems');
            const orderTotalEl = document.getElementById('orderTotal');
            
            if (!orderItemsEl || !orderTotalEl) return;
            
            const typeItems = orderItems.filter(item => item.type === type);
            
            if (typeItems.length === 0) {
                orderItemsEl.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">üì¶ Belum ada item order</p>';
                orderTotalEl.innerHTML = '';
                return;
            }
            
            orderItemsEl.innerHTML = typeItems.map((item, index) => `
                <div class="order-item">
                    <div class="order-item-info">
                        <div style="font-weight: 600; margin-bottom: 5px;">
                            ${item.product}
                            ${item.category ? `<span style="background: #e9ecef; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">${item.category}</span>` : ''}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${item.quantity} x Rp ${item.price.toLocaleString('id-ID')} = Rp ${item.total.toLocaleString('id-ID')}
                        </div>
                        ${item.customer ? `<div style="font-size: 11px; color: #28a745;">üè™ ${item.customer}</div>` : ''}
                    </div>
                    <div class="order-item-actions">
                        <button class="edit-btn" onclick="editOrderItem(${item.id})">‚úèÔ∏è</button>
                        <button class="remove-btn" onclick="removeOrderItem(${item.id})">‚ùå</button>
                    </div>
                </div>
            `).join('');
            
            const total = typeItems.reduce((sum, item) => sum + item.total, 0);
            orderTotalEl.innerHTML = `
                <div style="background: #28a745; color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; margin-top: 10px;">
                    üí∞ Total Order: Rp ${total.toLocaleString('id-ID')}
                </div>
            `;
        }
        
        // Remove order item with confirmation popup
        function removeOrderItem(itemId) {
            const item = orderItems.find(item => item.id === itemId);
            if (!item) return;
            
            showConfirmationPopup(
                'Hapus Item Order', 
                `Yakin ingin menghapus "${item.product}" dari order?`,
                () => {
                    orderItems = orderItems.filter(item => item.id !== itemId);
                    updateOrderDisplay(item.type);
                    alert('‚úÖ Item berhasil dihapus');
                }
            );
        }
        
        // Edit order item
        function editOrderItem(itemId) {
            const item = orderItems.find(item => item.id === itemId);
            if (!item) return;
            
            const newQuantity = prompt(`Edit jumlah untuk "${item.product}":`, item.quantity);
            if (newQuantity && !isNaN(newQuantity) && newQuantity > 0) {
                item.quantity = parseInt(newQuantity);
                item.total = item.quantity * item.price;
                updateOrderDisplay(item.type);
                alert('‚úÖ Jumlah berhasil diupdate');
            }
        }
        
        // Show confirmation popup with cancel button
        function showConfirmationPopup(title, message, onConfirm) {
            const popup = document.createElement('div');
            popup.className = 'confirmation-popup';
            popup.innerHTML = `
                <div class="popup-overlay" onclick="closeConfirmationPopup()"></div>
                <div class="popup-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                    <div class="popup-actions">
                        <button onclick="closeConfirmationPopup()" class="btn btn-secondary">‚ùå Batal</button>
                        <button onclick="confirmAction()" class="btn btn-danger">‚úÖ Ya, Hapus</button>
                    </div>
                </div>
                <style>
                .confirmation-popup {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 1000;
                }
                
                .popup-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                }
                
                .popup-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 25px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    min-width: 300px;
                    max-width: 90%;
                }
                
                .popup-content h4 {
                    margin: 0 0 15px 0;
                    color: #333;
                    text-align: center;
                }
                
                .popup-content p {
                    margin: 0 0 20px 0;
                    color: #666;
                    text-align: center;
                    line-height: 1.4;
                }
                
                .popup-actions {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                }
                </style>
            `;
            
            document.body.appendChild(popup);
            
            // Store the confirm function
            window.currentConfirmAction = onConfirm;
        }
        
        function closeConfirmationPopup() {
            const popup = document.querySelector('.confirmation-popup');
            if (popup) {
                document.body.removeChild(popup);
            }
        }
        
        function confirmAction() {
            if (window.currentConfirmAction) {
                window.currentConfirmAction();
            }
            closeConfirmationPopup();
        }

        // Update Order Display
        function updateOrderDisplay(type) {
            const suffix = type === 'telpon' ? 'Telpon' : '';
            const orderItemsContainer = document.getElementById(`orderItems${suffix}`);
            const orderTotalContainer = document.getElementById(`orderTotal${suffix}`);
            
            const filteredItems = orderItems.filter(item => item.type === type);
            
            let itemsHtml = '';
            let total = 0;
            
            filteredItems.forEach(item => {
                total += item.total;
                itemsHtml += `
                    <div class="order-item">
                        <span class="order-type ${item.type === 'telpon' ? 'order-telpon' : 'order-kunjungan'}">
                            ${item.type === 'telpon' ? 'üìû TELPON' : 'üö∂ KUNJUNGAN'}
                        </span>
                        <h5>${item.product}</h5>
                        <p>Qty: ${item.quantity} x Rp ${item.price.toLocaleString()} = Rp ${item.total.toLocaleString()}</p>
                        <button onclick="removeOrderItem(${item.id}, '${type}')" class="btn btn-danger" style="width: auto; padding: 5px 10px; margin-top: 5px;">üóëÔ∏è Hapus</button>
                    </div>
                `;
            });
            
            orderItemsContainer.innerHTML = itemsHtml || '<p>Belum ada item order</p>';
            orderTotalContainer.innerHTML = `<h4>üí∞ Total: Rp ${total.toLocaleString()}</h4>`;
        }

        // Auto-add new store to call plan
        function autoAddToCallPlan(storeName) {
            // Check if store is already in call plan
            const existingStore = storeData.find(store => store.name === storeName);
            
            if (!existingStore) {
                // Get store location based on kecamatan (simplified)
                const newStoreData = generateNewStoreData(storeName);
                
                // Add to store data
                storeData.push(newStoreData);
                
                // Auto-add to selected stores for next call plan
                selectedStores.push(newStoreData.id);
                
                console.log(`üìç Toko baru "${storeName}" ditambahkan ke call plan:`, newStoreData);
                
                // Update displays
                displayStores();
                updateCounter();
                
                return true;
            }
            
            return false; // Store already exists
        }
        
        // Generate new store data for auto-add
        function generateNewStoreData(storeName) {
            const kecamatanList = ['Kebon Jeruk', 'Grogol Petamburan', 'Taman Sari', 'Tambora', 'Cengkareng'];
            const randomKecamatan = kecamatanList[Math.floor(Math.random() * kecamatanList.length)];
            
            return {
                id: `store-${Date.now()}`,
                name: storeName,
                address: `Jl. ${storeName} No. ${Math.floor(Math.random() * 100) + 1}`,
                kecamatan: randomKecamatan,
                lat: -6.1944 + (Math.random() - 0.5) * 0.1,
                lng: 106.7831 + (Math.random() - 0.5) * 0.1,
                type: 'Toko Baru',
                isNewStore: true,
                addedDate: new Date().toLocaleDateString('id-ID')
            };
        }

        // Store validation state
        let storeValidation = {
            barcode: false,
            gps: false,
            selfie: false
        };

        // Scan Barcode Toko
        function scanBarcode() {
            // Simulate barcode scanner (in real app would use camera API)
            const barcodes = ['TK001', 'TK002', 'TK003', 'TK004', 'TK005'];
            const scannedCode = barcodes[Math.floor(Math.random() * barcodes.length)];
            
            alert('üì± Scanning barcode...');
            
            setTimeout(() => {
                storeValidation.barcode = true;
                updateValidationStatus();
                alert(`‚úÖ Barcode berhasil discan!\nKode Toko: ${scannedCode}`);
            }, 2000);
        }

        // Validate GPS Location
        function validateGPS() {
            alert('üìç Memvalidasi lokasi GPS...');
            
            // Simulate GPS validation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        storeValidation.gps = true;
                        updateValidationStatus();
                        alert(`‚úÖ GPS berhasil divalidasi!\nLokasi: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                    },
                    function(error) {
                        // Fallback untuk demo
                        storeValidation.gps = true;
                        updateValidationStatus();
                        alert('‚úÖ GPS berhasil divalidasi!\nLokasi: -6.1944, 106.7831 (Demo)');
                    }
                );
            } else {
                // Fallback untuk demo
                setTimeout(() => {
                    storeValidation.gps = true;
                    updateValidationStatus();
                    alert('‚úÖ GPS berhasil divalidasi!\nLokasi: -6.1944, 106.7831 (Demo)');
                }, 1500);
            }
        }

        // Take Selfie at Store
        function takeSelfie() {
            // In real app, this would open camera
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            
            alert('ü§≥ Membuka kamera untuk selfie...\n\n‚ö†Ô∏è Pastikan:\n‚Ä¢ Wajah Anda terlihat jelas\n‚Ä¢ Papan nama toko terlihat di latar belakang\n‚Ä¢ Tidak menggunakan foto dari galeri');
            
            // Simulate camera access (real implementation would use getUserMedia)
            navigator.mediaDevices = navigator.mediaDevices || {};
            
            setTimeout(() => {
                storeValidation.selfie = true;
                updateValidationStatus();
                alert('‚úÖ Selfie berhasil diambil!\nüì∏ Foto tersimpan dengan timestamp dan GPS coordinate');
            }, 3000);
        }

        // Update validation status display
        function updateValidationStatus() {
            const statusEl = document.getElementById('validationStatus');
            if (!statusEl) return;
            
            const barcodeStatus = storeValidation.barcode ? '‚úÖ' : '‚ùå';
            const gpsStatus = storeValidation.gps ? '‚úÖ' : '‚ùå';
            const selfieStatus = storeValidation.selfie ? '‚úÖ' : '‚ùå';
            
            const allValid = storeValidation.barcode && storeValidation.gps && storeValidation.selfie;
            
            statusEl.innerHTML = `
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <span>${barcodeStatus} Barcode</span>
                    <span>${gpsStatus} GPS</span>
                    <span>${selfieStatus} Selfie</span>
                </div>
                ${allValid ? '<div style="color: green; font-weight: bold; margin-top: 10px;">üéâ Semua validasi lengkap!</div>' : '<div style="color: orange;">‚ö†Ô∏è Lengkapi semua validasi untuk toko baru</div>'}
            `;
        }

        // Remove Order Item
        function removeOrderItem(itemId, type) {
            orderItems = orderItems.filter(item => item.id !== itemId);
            updateOrderDisplay(type);
            alert('üóëÔ∏è Item berhasil dihapus!');
        }

        // Submit Order
        function submitOrder(type) {
            const filteredItems = orderItems.filter(item => item.type === type);
            
            if (filteredItems.length === 0) {
                alert('‚ùå Tidak ada item untuk di-order!');
                return;
            }
            
            let customer = '';
            if (type === 'telpon') {
                const customerName = document.getElementById('customerName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                
                if (!customerName || !customerPhone) {
                    alert('‚ùå Lengkapi nama dan nomor telepon customer!');
                    return;
                }
                customer = `${customerName} (${customerPhone})`;
            } else {
                const customerSelect = document.getElementById('customerSelect');
                customer = customerSelect.value;
                
                if (!customer) {
                    alert('‚ùå Pilih customer terlebih dahulu!');
                    return;
                }
            }
            
            const total = filteredItems.reduce((sum, item) => sum + item.total, 0);
            const orderNumber = `ORD-${Date.now()}`;
            
            // Simulate order submission
            alert('‚è≥ Memproses order...');
            
            setTimeout(() => {
                let message = `‚úÖ Order Berhasil Disubmit!\n\n`;
                message += `üìã No. Order: ${orderNumber}\n`;
                message += `üè™ Customer: ${customer}\n`;
                message += `üìû Jenis: ${type === 'telpon' ? 'Order via Telepon' : 'Order via Kunjungan'}\n`;
                message += `üì¶ Total Item: ${filteredItems.length}\n`;
                message += `üí∞ Total Nilai: Rp ${total.toLocaleString()}\n\n`;
                message += `üì° Order telah dikirim ke sistem!`;
                
                // Auto-add new store to call plan if it's a kunjungan order
                if (type === 'kunjungan') {
                    const addedToCallPlan = autoAddToCallPlan(customer);
                    if (addedToCallPlan) {
                        message += `\n\nüéØ Toko "${customer}" telah ditambahkan ke Call Plan secara otomatis!`;
                    }
                }
                
                alert(message);
                
                // Clear order items for this type
                orderItems = orderItems.filter(item => item.type !== type);
                updateOrderDisplay(type);
                
                // Clear form
                if (type === 'telpon') {
                    document.getElementById('customerName').value = '';
                    document.getElementById('customerPhone').value = '';
                } else {
                    document.getElementById('customerSelect').value = '';
                }
            }, 2000);
        }

        // Show Info Dashboard
        function showInfo() {
            const content = `
                <div class="section-title">üìä Dashboard Info</div>
                
                <div class="info-section">
                    <h4>üì¶ Info Stock Toko</h4>
                    <textarea id="stockInfo" class="form-textarea" placeholder="Masukkan info stock toko (produk habis, produk baru, dll)"></textarea>
                    <button onclick="saveInfo('stock')" class="btn btn-primary">üíæ Simpan Info Stock</button>
                </div>
                
                <div class="info-section">
                    <h4>üè™ Info Pesaing</h4>
                    <textarea id="competitorInfo" class="form-textarea" placeholder="Masukkan info pesaing (harga, promo, strategi, dll)"></textarea>
                    <button onclick="saveInfo('competitor')" class="btn btn-primary">üíæ Simpan Info Pesaing</button>
                </div>
                
                <div class="info-section">
                    <h4>üì∏ Laporan Visual</h4>
                    <div class="file-upload" onclick="document.getElementById('photoInput').click()">
                        <p>üì∏ Ambil Foto Lapangan</p>
                        <small>Klik untuk mengambil atau upload foto</small>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="camera" multiple style="display: none;">
                    <div id="photoPreview" class="camera-preview"></div>
                </div>
                
                <div class="info-section">
                    <h4>üìù Info Lainnya</h4>
                    <textarea id="otherInfo" class="form-textarea" placeholder="Informasi lain yang perlu dilaporkan"></textarea>
                    <button onclick="saveInfo('other')" class="btn btn-primary">üíæ Simpan Info Lainnya</button>
                </div>
                
                <button onclick="submitAllInfo()" class="btn btn-success">üöÄ Kirim Semua Laporan</button>
            `;
            
            showContent(content);
            setupPhotoHandlers();
        }

        // Setup Photo Handlers
        function setupPhotoHandlers() {
            document.getElementById('photoInput').addEventListener('change', function(e) {
                const files = e.target.files;
                const preview = document.getElementById('photoPreview');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-preview';
                        photoDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Photo">
                            <button class="remove-photo" onclick="removePhoto(this)">√ó</button>
                        `;
                        preview.appendChild(photoDiv);
                        
                        capturedPhotos.push({
                            id: Date.now() + i,
                            data: e.target.result,
                            file: file
                        });
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                if (files.length > 0) {
                    alert(`üì∏ ${files.length} foto berhasil diambil!`);
                }
            });
        }

        // Remove Photo
        function removePhoto(button) {
            const photoDiv = button.parentElement;
            photoDiv.remove();
            alert('üóëÔ∏è Foto berhasil dihapus!');
        }

        // Save Info
        function saveInfo(type) {
            let infoText = '';
            let infoName = '';
            
            switch(type) {
                case 'stock':
                    infoText = document.getElementById('stockInfo').value;
                    infoName = 'Info Stock';
                    break;
                case 'competitor':
                    infoText = document.getElementById('competitorInfo').value;
                    infoName = 'Info Pesaing';
                    break;
                case 'other':
                    infoText = document.getElementById('otherInfo').value;
                    infoName = 'Info Lainnya';
                    break;
            }
            
            if (infoText.trim()) {
                alert(`‚úÖ ${infoName} berhasil disimpan!`);
                console.log(`${infoName}:`, infoText);
            } else {
                alert(`‚ùå Masukkan ${infoName.toLowerCase()} terlebih dahulu!`);
            }
        }

        // Submit All Info
        function submitAllInfo() {
            const stockInfo = document.getElementById('stockInfo')?.value || '';
            const competitorInfo = document.getElementById('competitorInfo')?.value || '';
            const otherInfo = document.getElementById('otherInfo')?.value || '';
            const photoCount = capturedPhotos.length;
            
            if (!stockInfo && !competitorInfo && !otherInfo && photoCount === 0) {
                alert('‚ùå Tidak ada informasi untuk dikirim!');
                return;
            }
            
            alert(`üöÄ Semua laporan berhasil dikirim!\n\nüì¶ Info Stock: ${stockInfo ? '‚úÖ' : '‚ùå'}\nüè™ Info Pesaing: ${competitorInfo ? '‚úÖ' : '‚ùå'}\nüì∏ Foto: ${photoCount} gambar\nüìù Info Lainnya: ${otherInfo ? '‚úÖ' : '‚ùå'}\n\nüì° Data telah dikirim ke server!`);
        }

        // Show Performance Dashboard
        function showPerforma() {
            const content = `
                <div class="section-title">üìà Dashboard Performa</div>
                
                <div class="period-tabs">
                    <div class="period-tab ${currentPeriod === 'daily' ? 'active' : ''}" onclick="changePeriod('daily')">Harian</div>
                    <div class="period-tab ${currentPeriod === 'weekly' ? 'active' : ''}" onclick="changePeriod('weekly')">Mingguan</div>
                    <div class="period-tab ${currentPeriod === 'monthly' ? 'active' : ''}" onclick="changePeriod('monthly')">Bulanan</div>
                </div>
                
                <div class="performance-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="visitsStat">${performanceData[currentPeriod].visits}</div>
                        <div class="stat-label">üë• Kunjungan</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="ordersStat">${performanceData[currentPeriod].orders}</div>
                        <div class="stat-label">üì¶ Order</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="billsStat">${performanceData[currentPeriod].bills}</div>
                        <div class="stat-label">üí≥ Tagihan</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="customersStat">${performanceData[currentPeriod].newCustomers}</div>
                        <div class="stat-label">üÜï Customer Baru</div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>üìä Ringkasan Performa</h4>
                    <div id="performanceSummary">
                        ${generatePerformanceSummary()}
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>üéØ Target vs Pencapaian</h4>
                    <div id="targetAnalysis">
                        ${generateTargetAnalysis()}
                    </div>
                </div>
            `;
            
            showContent(content);
        }

        // Change Period
        function changePeriod(period) {
            currentPeriod = period;
            
            // Update tab active state
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update statistics
            document.getElementById('visitsStat').textContent = performanceData[period].visits;
            document.getElementById('ordersStat').textContent = performanceData[period].orders;
            document.getElementById('billsStat').textContent = performanceData[period].bills;
            document.getElementById('customersStat').textContent = performanceData[period].newCustomers;
            
            // Update summary
            document.getElementById('performanceSummary').innerHTML = generatePerformanceSummary();
            document.getElementById('targetAnalysis').innerHTML = generateTargetAnalysis();
        }

        // Generate Performance Summary
        function generatePerformanceSummary() {
            const data = performanceData[currentPeriod];
            const conversionRate = Math.round((data.orders / data.visits) * 100);
            const periodName = currentPeriod === 'daily' ? 'hari ini' : 
                              currentPeriod === 'weekly' ? 'minggu ini' : 'bulan ini';
            
            return `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p><strong>üìà Tingkat Konversi:</strong> ${conversionRate}% (${data.orders} order dari ${data.visits} kunjungan)</p>
                    <p><strong>üí∞ Rata-rata Tagihan:</strong> ${Math.round(data.bills / data.visits * 100)}% dari kunjungan berhasil ditagih</p>
                    <p><strong>üÜï Akuisisi Customer:</strong> ${data.newCustomers} customer baru ${periodName}</p>
                    <p><strong>‚≠ê Performa:</strong> ${conversionRate >= 70 ? 'üü¢ Excellent' : conversionRate >= 50 ? 'üü° Good' : 'üî¥ Needs Improvement'}</p>
                </div>
            `;
        }

        // Generate Target Analysis
        function generateTargetAnalysis() {
            const data = performanceData[currentPeriod];
            const targets = {
                daily: { visits: 10, orders: 7, bills: 5, newCustomers: 3 },
                weekly: { visits: 50, orders: 35, bills: 25, newCustomers: 10 },
                monthly: { visits: 200, orders: 140, bills: 100, newCustomers: 30 }
            };
            
            const target = targets[currentPeriod];
            
            return `
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                    <p><strong>üë• Kunjungan:</strong> ${data.visits}/${target.visits} ${data.visits >= target.visits ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>üì¶ Order:</strong> ${data.orders}/${target.orders} ${data.orders >= target.orders ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>üí≥ Tagihan:</strong> ${data.bills}/${target.bills} ${data.bills >= target.bills ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>üÜï Customer Baru:</strong> ${data.newCustomers}/${target.newCustomers} ${data.newCustomers >= target.newCustomers ? '‚úÖ' : '‚ùå'}</p>
                    <br>
                    <p><strong>üéØ Pencapaian Target:</strong> ${Math.round(((data.visits + data.orders + data.bills + data.newCustomers) / (target.visits + target.orders + target.bills + target.newCustomers)) * 100)}%</p>
                </div>
            `;
        }

        // Show Tagihan Telpon Dashboard
        function showTagihanTelpon() {
            const content = `
                <div class="section-title">üìûüí≥ Dashboard Tagihan Telpon</div>
                
                <div class="alert alert-success">
                    ‚ÑπÔ∏è Tagihan dari customer via telepon tanpa kunjungan
                </div>
                
                <div class="tagihan-list">
                    <div class="tagihan-item" onclick="selectTagihanTelpon(this, 'INV-TEL-2025-001', 1850000)">
                        <div class="tagihan-header">
                            <h4>üìû Toko Digital Prima</h4>
                            <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                        </div>
                        <p><strong>üìÑ No. Faktur:</strong> INV-TEL-2025-001</p>
                        <p><strong>üìÖ Tanggal Faktur:</strong> 2025-09-08</p>
                        <p><strong>üìû Order via:</strong> Telepon (081234567890)</p>
                        <p><strong>‚è∞ Jumlah Hari:</strong> 2 hari</p>
                        <p><strong>üí∞ Total Faktur:</strong> Rp 1.850.000</p>
                    </div>
                    
                    <div class="tagihan-item" onclick="selectTagihanTelpon(this, 'INV-TEL-2025-002', 3200000)">
                        <div class="tagihan-header">
                            <h4>üìû Warung Telpon Jaya</h4>
                            <span class="tagihan-status status-terlambat">‚ö†Ô∏è Terlambat</span>
                        </div>
                        <p><strong>üìÑ No. Faktur:</strong> INV-TEL-2025-002</p>
                        <p><strong>üìÖ Tanggal Faktur:</strong> 2025-08-25</p>
                        <p><strong>üìû Order via:</strong> Telepon (082345678901)</p>
                        <p><strong>‚è∞ Jumlah Hari:</strong> 16 hari</p>
                        <p><strong>üí∞ Total Faktur:</strong> Rp 3.200.000</p>
                    </div>
                    
                    <div class="tagihan-item" onclick="selectTagihanTelpon(this, 'INV-TEL-2025-003', 2750000)">
                        <div class="tagihan-header">
                            <h4>üìû Minimarket Online</h4>
                            <span class="tagihan-status status-lancar">‚úÖ Lancar</span>
                        </div>
                        <p><strong>üìÑ No. Faktur:</strong> INV-TEL-2025-003</p>
                        <p><strong>üìÖ Tanggal Faktur:</strong> 2025-09-06</p>
                        <p><strong>üìû Order via:</strong> Telepon (083456789012)</p>
                        <p><strong>‚è∞ Jumlah Hari:</strong> 4 hari</p>
                        <p><strong>üí∞ Total Faktur:</strong> Rp 2.750.000</p>
                    </div>
                </div>
                
                <div id="paymentFormTelpon" class="payment-form">
                    <h4>üí≥ Form Pembayaran Telepon</h4>
                    <div id="selectedBillTelpon"></div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmountTelpon" class="form-input" placeholder="Masukkan jumlah pembayaran" onkeyup="validatePaymentAmountTelpon()">
                        <small id="paymentValidationTelpon" class="payment-validation"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jenis Pembayaran</label>
                        <div class="payment-type-section">
                            <button type="button" id="lunasBtnTelpon" class="payment-type-btn" onclick="setPaymentTypeTelpon('lunas')">‚úÖ Lunas</button>
                            <button type="button" id="titipBtnTelpon" class="payment-type-btn" onclick="setPaymentTypeTelpon('titip')">üì¶ Titip</button>
                        </div>
                        <input type="hidden" id="selectedPaymentTypeTelpon" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí≥ Metode Pembayaran</label>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethodTelpon(this, 'cash')">üíµ Cash</div>
                            <div class="payment-method" onclick="selectPaymentMethodTelpon(this, 'transfer')">üè¶ Transfer</div>
                            <div class="payment-method" onclick="selectPaymentMethodTelpon(this, 'cek')">üìÑ Cek</div>
                            <div class="payment-method" onclick="selectPaymentMethodTelpon(this, 'giro')">üìã Giro</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmountTelpon" class="form-input" placeholder="Masukkan jumlah pembayaran">
                    </div>
                    
                    <div id="fileUploadSectionTelpon" class="file-upload hidden" onclick="document.getElementById('paymentProofTelpon').click()">
                        <p>üì∏ Upload Bukti Pembayaran</p>
                        <small>Klik untuk upload foto bukti transfer/cek/giro</small>
                        <input type="file" id="paymentProofTelpon" accept="image/*" style="display: none;">
                    </div>
                    
                    <button onclick="submitPaymentTelpon()" class="btn btn-success">‚úÖ Proses Pembayaran</button>
                    <button onclick="hidePaymentFormTelpon()" class="btn btn-secondary">‚ùå Batal</button>
                </div>
            `;
            
            showContent(content);
        }

        // Global variables for telpon payment validation
        let currentInvoiceAmountTelpon = 0;
        let currentInvoiceNoTelpon = '';
        
        // Select Tagihan Telpon
        function selectTagihanTelpon(element, invoiceNo, amount) {
            document.querySelectorAll('.tagihan-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            element.classList.add('selected');
            
            // Store current invoice data
            currentInvoiceAmountTelpon = amount;
            currentInvoiceNoTelpon = invoiceNo;
            
            document.getElementById('paymentFormTelpon').style.display = 'block';
            document.getElementById('selectedBillTelpon').innerHTML = `<strong>Faktur telepon terpilih:</strong> ${invoiceNo}<br><strong>Total Faktur:</strong> Rp ${amount.toLocaleString('id-ID')}`;
            
            // Reset form
            document.getElementById('paymentAmountTelpon').value = '';
            document.getElementById('selectedPaymentTypeTelpon').value = '';
            document.querySelectorAll('.payment-type-btn').forEach(btn => {
                btn.classList.remove('active', 'disabled');
            });
            document.getElementById('paymentValidationTelpon').innerHTML = '';
        }
        
        // Validate payment amount telpon
        function validatePaymentAmountTelpon() {
            const paymentAmount = parseFloat(document.getElementById('paymentAmountTelpon').value) || 0;
            const validationEl = document.getElementById('paymentValidationTelpon');
            const lunasBtn = document.getElementById('lunasBtnTelpon');
            const titipBtn = document.getElementById('titipBtnTelpon');
            
            // Reset buttons
            lunasBtn.classList.remove('active', 'disabled');
            titipBtn.classList.remove('active', 'disabled');
            document.getElementById('selectedPaymentTypeTelpon').value = '';
            
            if (paymentAmount <= 0) {
                validationEl.innerHTML = '';
                return;
            }
            
            if (paymentAmount >= currentInvoiceAmountTelpon) {
                // Payment sufficient for LUNAS
                validationEl.innerHTML = '‚úÖ Pembayaran cukup untuk LUNAS';
                validationEl.className = 'payment-validation valid';
                
                // Enable lunas, disable titip
                lunasBtn.classList.add('active');
                titipBtn.classList.add('disabled');
                document.getElementById('selectedPaymentTypeTelpon').value = 'lunas';
                
            } else {
                // Payment insufficient, only TITIP allowed
                validationEl.innerHTML = '‚ö†Ô∏è Pembayaran kurang, otomatis TITIP';
                validationEl.className = 'payment-validation invalid';
                
                // Enable titip, disable lunas
                titipBtn.classList.add('active');
                lunasBtn.classList.add('disabled');
                document.getElementById('selectedPaymentTypeTelpon').value = 'titip';
            }
        }
        
        // Set payment type telpon
        function setPaymentTypeTelpon(type) {
            const paymentAmount = parseFloat(document.getElementById('paymentAmountTelpon').value) || 0;
            
            if (paymentAmount <= 0) {
                alert('‚ùå Masukkan jumlah pembayaran terlebih dahulu!');
                return;
            }
            
            // Validate if lunas is possible
            if (type === 'lunas' && paymentAmount < currentInvoiceAmountTelpon) {
                alert(`‚ùå Tidak bisa LUNAS! Pembayaran Rp ${paymentAmount.toLocaleString('id-ID')} kurang dari total faktur Rp ${currentInvoiceAmountTelpon.toLocaleString('id-ID')}`);
                return;
            }
            
            // Update buttons
            document.querySelectorAll('.payment-type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(type + 'BtnTelpon').classList.add('active');
            document.getElementById('selectedPaymentTypeTelpon').value = type;
        }

        // Select Payment Method Telpon
        function selectPaymentMethodTelpon(element, method) {
            document.querySelectorAll('.payment-method').forEach(item => {
                item.classList.remove('selected');
            });
            
            element.classList.add('selected');
            
            const fileUploadSection = document.getElementById('fileUploadSectionTelpon');
            if (method === 'transfer' || method === 'cek' || method === 'giro') {
                fileUploadSection.classList.remove('hidden');
            } else {
                fileUploadSection.classList.add('hidden');
            }
        }

        // Hide Payment Form Telpon
        function hidePaymentFormTelpon() {
            document.getElementById('paymentFormTelpon').style.display = 'none';
            document.querySelectorAll('.tagihan-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Submit Payment Telpon
        function submitPaymentTelpon() {
            const paymentType = document.querySelector('input[name="paymentTypeTelpon"]:checked');
            const paymentMethod = document.querySelector('.payment-method.selected');
            const paymentAmount = document.getElementById('paymentAmountTelpon').value;
            
            if (!paymentType || !paymentMethod || !paymentAmount) {
                alert('‚ùå Lengkapi semua field pembayaran!');
                return;
            }
            
            const methodText = paymentMethod.textContent;
            const needsProof = methodText.includes('Transfer') || methodText.includes('Cek') || methodText.includes('Giro');
            const proofFile = document.getElementById('paymentProofTelpon').files[0];
            
            if (needsProof && !proofFile) {
                alert('‚ùå Upload bukti pembayaran untuk metode ini!');
                return;
            }
            
            alert('‚è≥ Memproses pembayaran telepon...');
            
            setTimeout(() => {
                let message = `‚úÖ Pembayaran Telepon Berhasil Diproses!\n\n`;
                message += `üìû Jenis: Tagihan via Telepon\n`;
                message += `üí∞ Jumlah: Rp ${parseInt(paymentAmount).toLocaleString()}\n`;
                message += `üí≥ Metode: ${methodText}\n`;
                message += `üìã Jenis: ${paymentType.value === 'lunas' ? 'Lunas' : 'Titip'}\n\n`;
                
                if (methodText.includes('Transfer')) {
                    message += `üè¶ Status: Menunggu konfirmasi bank\n`;
                    message += `üì± Customer akan dapat notifikasi WhatsApp setelah dana masuk rekening`;
                } else if (methodText.includes('Cash')) {
                    message += `üíµ Status: Uang dibawa salesman\n`;
                    message += `üì± Customer akan dapat konfirmasi setelah uang disetor ke rekening`;
                } else {
                    message += `üìÑ Status: Menunggu pencairan\n`;
                    message += `üì± Customer akan dapat konfirmasi setelah cek/giro cair`;
                }
                
                alert(message);
                hidePaymentFormTelpon();
            }, 2000);
        }

        // Show Stock Dashboard
        function showStock() {
            // Data stok dengan orderan masuk
            const stockData = [
                { 
                    jenis: 'Makanan', 
                    nama: 'Indomie Goreng', 
                    satuan: 'Dus (40 pcs)', 
                    jumlah: 150, 
                    orderMasuk: 25, 
                    sisa: 125 
                },
                { 
                    jenis: 'Minuman', 
                    nama: 'Teh Botol Sosro', 
                    satuan: 'Karton (24 botol)', 
                    jumlah: 80, 
                    orderMasuk: 12, 
                    sisa: 68 
                },
                { 
                    jenis: 'Minuman', 
                    nama: 'Aqua 600ml', 
                    satuan: 'Karton (24 botol)', 
                    jumlah: 200, 
                    orderMasuk: 35, 
                    sisa: 165 
                },
                { 
                    jenis: 'Sembako', 
                    nama: 'Beras Premium', 
                    satuan: 'Karung (25kg)', 
                    jumlah: 50, 
                    orderMasuk: 8, 
                    sisa: 42 
                },
                { 
                    jenis: 'Sembako', 
                    nama: 'Minyak Goreng', 
                    satuan: 'Jerigen (5L)', 
                    jumlah: 60, 
                    orderMasuk: 18, 
                    sisa: 42 
                },
                { 
                    jenis: 'Makanan', 
                    nama: 'Biskuit Marie', 
                    satuan: 'Karton (48 pack)', 
                    jumlah: 40, 
                    orderMasuk: 6, 
                    sisa: 34 
                },
                { 
                    jenis: 'Minuman', 
                    nama: 'Susu UHT', 
                    satuan: 'Karton (24 kotak)', 
                    jumlah: 75, 
                    orderMasuk: 15, 
                    sisa: 60 
                }
            ];

            let stockTableRows = '';
            stockData.forEach(item => {
                const statusColor = item.sisa < 20 ? 'status-terlambat' : item.sisa < 50 ? 'status-warning' : 'status-lancar';
                const statusIcon = item.sisa < 20 ? 'üî¥' : item.sisa < 50 ? 'üü°' : 'üü¢';
                
                stockTableRows += `
                    <div class="stock-item">
                        <div class="stock-header">
                            <h4>${statusIcon} ${item.nama}</h4>
                            <span class="stock-status ${statusColor}">${item.jenis}</span>
                        </div>
                        <div class="stock-details">
                            <p><strong>üì¶ Satuan:</strong> ${item.satuan}</p>
                            <p><strong>üìä Jumlah Awal:</strong> ${item.jumlah}</p>
                            <p><strong>üì• Order Masuk:</strong> ${item.orderMasuk}</p>
                            <p><strong>üìã Jumlah Akhir:</strong> ${item.sisa}</p>
                            <div class="stock-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(item.sisa / item.jumlah) * 100}%"></div>
                                </div>
                                <span class="progress-text">${Math.round((item.sisa / item.jumlah) * 100)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            const content = `
                <div class="section-title">üì¶üìä Dashboard Stock</div>
                
                <div class="alert alert-success">
                    ‚ÑπÔ∏è Tampilan stock berdasarkan orderan masuk. Stock utama berkurang setelah pengiriman.
                </div>
                
                <div class="stock-summary">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number">${stockData.length}</span>
                            <span class="stat-label">Total Item</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${stockData.reduce((sum, item) => sum + item.orderMasuk, 0)}</span>
                            <span class="stat-label">Order Masuk</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${stockData.filter(item => item.sisa < 20).length}</span>
                            <span class="stat-label">Stock Rendah</span>
                        </div>
                    </div>
                </div>
                
                <div class="stock-list">
                    ${stockTableRows}
                </div>
                
                <div class="stock-notes">
                    <h4>üìù Keterangan:</h4>
                    <p>üü¢ <strong>Stock Aman:</strong> Sisa ‚â• 50 unit</p>
                    <p>üü° <strong>Stock Perhatian:</strong> Sisa 20-49 unit</p>
                    <p>üî¥ <strong>Stock Rendah:</strong> Sisa < 20 unit</p>
                    <br>
                    <p><em>* Stock ini hanya tampilan berdasarkan orderan masuk. Stock fisik akan berkurang setelah barang dikirim.</em></p>
                </div>
                
                <style>
                .stock-item {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    border-left: 4px solid #28a745;
                }
                
                .stock-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                }
                
                .stock-status {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 600;
                }
                
                .status-warning {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .stock-details p {
                    margin: 5px 0;
                    color: #666;
                }
                
                .stock-progress {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-top: 10px;
                }
                
                .progress-bar {
                    flex: 1;
                    height: 10px;
                    background: #e9ecef;
                    border-radius: 5px;
                    overflow: hidden;
                }
                
                .progress-fill {
                    height: 100%;
                    background: linear-gradient(90deg, #28a745, #20c997);
                    transition: width 0.3s ease;
                }
                
                .progress-text {
                    font-size: 12px;
                    font-weight: 600;
                    color: #495057;
                }
                
                .stock-summary {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                
                .summary-stats {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 15px;
                }
                
                .stat-item {
                    text-align: center;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                }
                
                .stat-number {
                    display: block;
                    font-size: 24px;
                    font-weight: bold;
                    color: #667eea;
                }
                
                .stat-label {
                    font-size: 14px;
                    color: #666;
                }
                
                .stock-notes {
                    background: #e3f2fd;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 20px;
                }
                
                .stock-notes h4 {
                    margin-bottom: 10px;
                    color: #1976d2;
                }
                
                .stock-notes p {
                    margin: 5px 0;
                    font-size: 14px;
                }
                </style>
            `;
            
            showContent(content);
        }

        // Show Content Function
        function showContent(content) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = content;
            contentArea.classList.remove('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            
            // Add alternative event listener for login button
            const loginBtn = document.querySelector('button[onclick="login()"]');
            if (loginBtn) {
                console.log('Login button found, adding event listener');
                loginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Login button clicked via event listener');
                    login();
                });
            } else {
                console.log('Login button not found!');
            }
            
            // Add Enter key support for login form
            const employeeIdInput = document.getElementById('employeeId');
            const passwordInput = document.getElementById('password');
            
            if (employeeIdInput && passwordInput) {
                [employeeIdInput, passwordInput].forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            console.log('Enter key pressed, attempting login');
                            login();
                        }
                    });
                });
            }
        });
        
        console.log('üêò GAJAH NUSA ERP - Sales Mobile Ready!');
        console.log('üì± Features: Call Plan, Tagihan, Orderan, Order Telpon, Info, Performa');
        console.log('üîó Login: EMP001 / password123');
    </script>
</body>
</html>

